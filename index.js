(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{nS:()=>Qe,Wc:()=>Ye,qH:()=>Xe,DH:()=>$e,YM:()=>Oe,Vq:()=>qe,n6:()=>He,hd:()=>Ve,cM:()=>We,XV:()=>Ne});var t="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;var i=Math.PI/180;function s(e){return e*i}function n(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(e,i,s){var n=new t(3);return n[0]=e,n[1]=i,n[2]=s,n}function a(e,t,i,s){return e[0]=t,e[1]=i,e[2]=s,e}function o(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function c(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function l(e,t){var i=t[0],s=t[1],n=t[2],r=i*i+s*s+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function h(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function u(e,t,i,s){var n=t[0],r=t[1],a=t[2],o=t[3],c=n+n,l=r+r,h=a+a,u=n*c,d=n*l,m=n*h,g=r*l,p=r*h,f=a*h,x=o*c,E=o*l,v=o*h,b=s[0],C=s[1],w=s[2];return e[0]=(1-(g+f))*b,e[1]=(d+v)*b,e[2]=(m-E)*b,e[3]=0,e[4]=(d-v)*C,e[5]=(1-(u+f))*C,e[6]=(p+x)*C,e[7]=0,e[8]=(m+E)*w,e[9]=(p-x)*w,e[10]=(1-(u+g))*w,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}n();function d(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function m(e,t,i,s,n){return e[0]=t,e[1]=i,e[2]=s,e[3]=n,e}function g(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function p(e,t,i,s){var n=.5*Math.PI/180;t*=n,i*=n,s*=n;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(i),c=Math.cos(i),l=Math.sin(s),h=Math.cos(s);return e[0]=r*c*h-a*o*l,e[1]=a*o*h+r*c*l,e[2]=a*c*l-r*o*h,e[3]=a*c*h+r*o*l,e}d();var f;n(),r(1,0,0),r(0,1,0),g(),g(),f=new t(9),t!=Float32Array&&(f[1]=0,f[2]=0,f[3]=0,f[5]=0,f[6]=0,f[7]=0),f[0]=1,f[4]=1,f[8]=1;const x=new ArrayBuffer(64),E=function(){const e=[];for(let t=1;t<=16;t++)e.push(new Float32Array(x,0,t));return e}(),v=[];function b(e){const t=e,i=E[t.length-1];return i.set(t),i}function C(e){return document.querySelector(e)}function w(e){return e/1e3/1e3}function T(e,t,i){const s=v.pop();return s?a(s,e,t,i):r(e,t,i)}function S(e){v.push(e)}class I{static getMaxFrustumDistance(){return this.maxFrustumDistance}static updateMaxFrustumDistance(){const e=function(e,t=window.innerWidth/window.innerHeight){return 2*Math.atan(Math.tan(.5*s(e))*t)}(Oe.getFovY());this.maxFrustumDistance=Oe.getViewDistance()/Math.cos(e/2)}constructor(){this.position=r(0,5,15),this.rotation=0,this.R=h(),this.q=g(),this.tempVec=n(),this.V=h(),this.P=h(),this.VP=h(),this.forward=n(),this.right=n(),this.valid=!1,I.updateMaxFrustumDistance()}getPosition(){return this.position}move(e){o(this.position,this.position,e),this.valid=!1}getRotation(){return this.rotation}rotate(e){this.rotation+=e,this.valid=!1}getVP(){return this.valid||(this.update(),this.valid=!0),this.VP}getForward(){return this.valid||(this.update(),this.valid=!0),this.forward}getRight(){return this.valid||(this.update(),this.valid=!0),this.right}update(){this.updateV(),this.updateP(),function(e,t,i){var s=t[0],n=t[1],r=t[2],a=t[3],o=t[4],c=t[5],l=t[6],h=t[7],u=t[8],d=t[9],m=t[10],g=t[11],p=t[12],f=t[13],x=t[14],E=t[15],v=i[0],b=i[1],C=i[2],w=i[3];e[0]=v*s+b*o+C*u+w*p,e[1]=v*n+b*c+C*d+w*f,e[2]=v*r+b*l+C*m+w*x,e[3]=v*a+b*h+C*g+w*E,v=i[4],b=i[5],C=i[6],w=i[7],e[4]=v*s+b*o+C*u+w*p,e[5]=v*n+b*c+C*d+w*f,e[6]=v*r+b*l+C*m+w*x,e[7]=v*a+b*h+C*g+w*E,v=i[8],b=i[9],C=i[10],w=i[11],e[8]=v*s+b*o+C*u+w*p,e[9]=v*n+b*c+C*d+w*f,e[10]=v*r+b*l+C*m+w*x,e[11]=v*a+b*h+C*g+w*E,v=i[12],b=i[13],C=i[14],w=i[15],e[12]=v*s+b*o+C*u+w*p,e[13]=v*n+b*c+C*d+w*f,e[14]=v*r+b*l+C*m+w*x,e[15]=v*a+b*h+C*g+w*E}(this.VP,this.P,this.V)}updateV(){!function(e,t){var i=t[0],s=t[1],n=t[2],r=t[3],a=i+i,o=s+s,c=n+n,l=i*a,h=s*a,u=s*o,d=n*a,m=n*o,g=n*c,p=r*a,f=r*o,x=r*c;e[0]=1-u-g,e[1]=h+x,e[2]=d-f,e[3]=0,e[4]=h-x,e[5]=1-l-g,e[6]=m+p,e[7]=0,e[8]=d+f,e[9]=m-p,e[10]=1-l-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this.R,p(this.q,0,-this.rotation,0)),function(e,t,i){var s,n,r,a,o,c,l,h,u,d,m,g,p=i[0],f=i[1],x=i[2];t===e?(e[12]=t[0]*p+t[4]*f+t[8]*x+t[12],e[13]=t[1]*p+t[5]*f+t[9]*x+t[13],e[14]=t[2]*p+t[6]*f+t[10]*x+t[14],e[15]=t[3]*p+t[7]*f+t[11]*x+t[15]):(s=t[0],n=t[1],r=t[2],a=t[3],o=t[4],c=t[5],l=t[6],h=t[7],u=t[8],d=t[9],m=t[10],g=t[11],e[0]=s,e[1]=n,e[2]=r,e[3]=a,e[4]=o,e[5]=c,e[6]=l,e[7]=h,e[8]=u,e[9]=d,e[10]=m,e[11]=g,e[12]=s*p+o*f+u*x+t[12],e[13]=n*p+c*f+d*x+t[13],e[14]=r*p+l*f+m*x+t[14],e[15]=a*p+h*f+g*x+t[15])}(this.V,this.R,function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}(this.tempVec,this.position)),a(this.forward,this.R[8],this.R[9],-this.R[10]),a(this.right,this.R[0],this.R[1],-this.R[2])}updateP(){const e=s(Oe.getFovY()),t=window.innerWidth/window.innerHeight,i=Oe.getViewDistance();He.getCapabilities().isNdcCube?function(e,t,i,s,n){var r,a=1/Math.tan(t/2);e[0]=a/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(r=1/(s-n),e[10]=(n+s)*r,e[14]=2*n*s*r):(e[10]=-1,e[14]=-2*s)}(this.P,e,t,.5,i):function(e,t,i,s,n){var r,a=1/Math.tan(t/2);e[0]=a/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(r=1/(.5-n),e[10]=n*r,e[14]=.5*n*r):(e[10]=-1,e[14]=-.5)}(this.P,e,t,0,i)}invalidate(){this.valid=!1}}var y,D,M,A;I.maxFrustumDistance=0,function(e){e[e.AUTO=0]="AUTO",e[e.WEBGL_1=1]="WEBGL_1",e[e.WEBGL_2=2]="WEBGL_2",e[e.WEBGPU=3]="WEBGPU"}(y||(y={}));class P{constructor(){this.renderingApi=y.AUTO,this.fovY=50,this.viewDistance=500,this.cellSize=100,this.instanceCount=100,this.statistics=!1,this.frustumCulling=!0,this.cellsDebugger=!1,this.loadApi(),this.loadStatistics(),this.loadFrustumCulling(),this.loadCellsDebugger(),this.loadFovY(),this.loadViewDistance(),this.loadCellSize(),this.loadInstanceCount()}loadApi(){const e=localStorage.getItem("renderingApi");if(null==e)return;const t=Number.parseInt(e);t!==y.AUTO&&t!==y.WEBGL_1&&t!==y.WEBGL_2&&t!==y.WEBGPU||(this.renderingApi=t)}loadStatistics(){const e=localStorage.getItem("statistics");null!=e&&(this.statistics="true"===e)}loadFrustumCulling(){const e=localStorage.getItem("frustumCulling");null!=e&&(this.frustumCulling="true"===e)}loadCellsDebugger(){const e=localStorage.getItem("cellsDebugger");null!=e&&(this.cellsDebugger="true"===e)}loadFovY(){const e=localStorage.getItem("fovY");null!=e&&(this.fovY=Math.min(Math.max(1,+e),179))}loadViewDistance(){const e=localStorage.getItem("viewDistance");null!=e&&(this.viewDistance=Math.max(+e,1))}loadCellSize(){const e=localStorage.getItem("cellSize");null!=e&&(this.cellSize=Math.max(+e,1))}loadInstanceCount(){const e=localStorage.getItem("instanceCount");null!=e&&(this.instanceCount=Math.max(+e,0))}getRenderingApi(){return this.renderingApi}setRenderingApi(e){this.renderingApi=e,localStorage.setItem("renderingApi",this.renderingApi.toString()),He.restart(),Qe.invalidate()}isStatistics(){return this.statistics}setStatistics(e){this.statistics=e,localStorage.setItem("statistics",this.statistics.toString()),e||We.hide()}isFrustumCulling(){return this.frustumCulling}setFrustumCulling(e){this.frustumCulling=e,localStorage.setItem("frustumCulling",this.frustumCulling.toString())}isCellsDebugger(){return this.cellsDebugger}setCellsDebugger(e){this.cellsDebugger=e,localStorage.setItem("cellsDebugger",this.cellsDebugger.toString()),Ye.update(),e?Ye.show():Ye.hide()}getFovY(){return this.fovY}setFovY(e){this.fovY=e,localStorage.setItem("fovY",this.fovY.toString()),I.updateMaxFrustumDistance(),Ye.update(),Qe.invalidate()}getViewDistance(){return this.viewDistance}setViewDistance(e){this.viewDistance=e,localStorage.setItem("viewDistance",this.viewDistance.toString()),I.updateMaxFrustumDistance(),Ye.update(),Qe.invalidate()}getCellSize(){return this.cellSize}setCellSize(e){this.cellSize=e,localStorage.setItem("cellSize",this.cellSize.toString()),He.removeAllCells(),Ye.update()}getInstanceCount(){return this.instanceCount}setInstanceCount(e){this.instanceCount=e,localStorage.setItem("instanceCount",this.instanceCount.toString()),He.removeAllCells(),Ye.update()}}class B{initializeShared(e){this.context=this.createContext(),this.context.enable(this.context.DEPTH_TEST),this.context.enable(this.context.CULL_FACE),Ve.increment("api-calls",2),He.getCapabilities().isNdcCube=!0,this.capabilitiesAndExtensions()}getContext(e){const t=He.getCanvas().getContext(e,{powerPreference:"high-performance",depth:!0,antialias:!1});return Ve.increment("api-calls",1),He.getCanvas().addEventListener("webglcontextlost",(e=>{console.log("WebGL context lost",e),$e()})),t}getId(){return this.context}handleResize(){}async stop(){this.context.flush(),Ve.increment("api-calls",1)}release(){}}class F extends B{constructor(){super(...arguments),this.gl1GpuTimeExtension=null,this.gl1InstancedRenderingExtension=null}initialize(){this.initializeShared("WebGL 1")}getId(){return this.context}capabilitiesAndExtensions(){this.gl1GpuTimeExtension=this.context.getExtension("EXT_disjoint_timer_query"),this.gl1InstancedRenderingExtension=this.context.getExtension("ANGLE_instanced_arrays"),Ve.increment("api-calls",2);let e=0;this.gl1GpuTimeExtension&&(e=this.gl1GpuTimeExtension.getQueryEXT(this.gl1GpuTimeExtension.TIME_ELAPSED_EXT,this.gl1GpuTimeExtension.QUERY_COUNTER_BITS_EXT),Ve.increment("api-calls",1)),He.getCapabilities().uniformBuffer=!1,He.getCapabilities().gpuTimer=!(!this.gl1GpuTimeExtension||!e),He.getCapabilities().instancedRendering=!!this.gl1InstancedRenderingExtension,He.getCapabilities().debugGroups=!1}createContext(){const e=this.getContext("webgl")||this.getContext("webgl-experimental");if(!e)throw new Error("Couldn't create a WebGL 1 context");return e}getGpuTimeExtension(){return this.gl1GpuTimeExtension}getInstancedRenderingExtension(){return this.gl1InstancedRenderingExtension}}class _ extends B{constructor(){super(...arguments),this.gl2GpuTimeExtension=null}initialize(){this.initializeShared("WebGL 2")}getGpuTimeExtension(){return this.gl2GpuTimeExtension}getId(){return this.context}capabilitiesAndExtensions(){this.gl2GpuTimeExtension=this.context.getExtension("EXT_disjoint_timer_query_webgl2"),Ve.increment("api-calls",1);let e=0;this.gl2GpuTimeExtension&&(e=this.context.getQuery(this.gl2GpuTimeExtension.TIME_ELAPSED_EXT,this.gl2GpuTimeExtension.QUERY_COUNTER_BITS_EXT),Ve.increment("api-calls",1)),He.getCapabilities().uniformBuffer=!0,He.getCapabilities().gpuTimer=!(!this.gl2GpuTimeExtension||!e),He.getCapabilities().instancedRendering=!0,He.getCapabilities().debugGroups=!1}createContext(){const e=this.getContext("webgl2");if(!e)throw new Error("Couldn't create a WebGL 2 context");return e}}class R{constructor(){this.deviceLostCount=0}async initialize(){this.checkWebGPUSupport();const e=await this.getAdapter();this.device=await this.createDevice(e),this.context=this.getContext(),He.getCapabilities().isNdcCube=!1,He.getCapabilities().uniformBuffer=!0,He.getCapabilities().instancedRendering=!0,He.getCapabilities().debugGroups=!0,this.handleResize()}getId(){return this.context}getCanvasFormat(){return this.canvasFormat}getDevice(){return this.device}getDepthView(){return this.depthView}getCurrentTexture(){return Ve.increment("api-calls",1),this.context.getCurrentTexture()}handleResize(){this.depth&&(this.depth.destroy(),Ve.increment("api-calls",1)),this.depth=this.device.createTexture({format:"depth32float",size:[window.innerWidth,window.innerHeight,1],usage:GPUTextureUsage.RENDER_ATTACHMENT}),this.depthView=this.depth.createView(),Ve.increment("api-calls",2)}checkWebGPUSupport(){if(!navigator.gpu)throw new Error("WebGPU isn't supported")}async getAdapter(){const e=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(Ve.increment("api-calls",1),!e||e.isFallbackAdapter)throw new Error("Couldn't get an adapter");return e}async logAdapterInfo(e){}async createDevice(e){const t=this.createDeviceDescriptor(e),i=await e.requestDevice(t);return Ve.increment("api-calls",1),i.lost.then((e=>{"destroyed"!==e.reason&&(console.error("Device lost"),console.error(`Reason: ${e.reason}`),console.error(`Message: ${e.message}`),this.deviceLostCount++,this.deviceLostCount<=5&&$e())})),i}createDeviceDescriptor(e){const t={},i="timestamp-query";return He.getCapabilities().gpuTimer=e.features.has(i),He.getCapabilities().gpuTimer&&(t.requiredFeatures=[i]),t}logDeviceInfo(e){}getContext(){const e=He.getCanvas().getContext("webgpu");if(!e)throw new Error("Couldn't create a WebGPU context");return this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),e.configure({format:this.canvasFormat,device:this.device}),Ve.increment("api-calls",3),e}async stop(){await this.device.queue.onSubmittedWorkDone(),Ve.increment("api-calls",1)}release(){this.depth.destroy(),this.context?.unconfigure(),this.device?.destroy(),Ve.increment("api-calls",3)}}function L(){return He.getContext()}function U(){return He.getContext()}function G(){return He.getContext()}class z{constructor(e){this.size=0,this.context=Pe()?U().getId():L().getId(),this.usage=e.usage,this.target=this.getTarget(),this.id=this.context.createBuffer(),Ve.increment("api-calls",1),this.bind(),this.allocate(e),Ve.increment("buffer-data",this.size)}getId(){return this.id}bind(){this.context.bindBuffer(this.target,this.id),Ve.increment("api-calls",1)}getSize(){return this.size}getUsage(){return this.usage}release(){this.context.deleteBuffer(this.id),Ve.increment("api-calls",1),Ve.increment("buffer-data",-this.size),this.size=0}}class N extends z{allocate(e){const t=e.dynamic?this.context.DYNAMIC_DRAW:this.context.STATIC_DRAW;"size"===e.type?(this.size=e.size,this.context.bufferData(this.target,e.size,t)):(this.size=e.dataLength??e.data.byteLength,this.context.bufferData(this.target,e.data,t,e.dataOffset??0,e.dataLength)),Ve.increment("api-calls",1)}getTarget(){switch(this.usage){case D.VERTEX:return this.context.ARRAY_BUFFER;case D.INDEX:return this.context.ELEMENT_ARRAY_BUFFER;case D.UNIFORM:return this.context.UNIFORM_BUFFER}}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(this.bind(),this.context.bufferSubData(this.target,e.offset??0,e.data,e.dataOffset??0,e.dataLength),Ve.increment("api-calls",1))}}class O{constructor(e){this.bindGroup=null,this.usage=e.usage,"size"===e.type?this.size=e.size:this.size=e.dataLength??e.data.byteLength;const t={size:this.size,usage:this.getGpuUsage(),label:e.label};this.buffer=G().getDevice().createBuffer(t),"data"===e.type&&this.setData({type:"buffer",data:e.data,dataOffset:e.dataOffset,dataLength:e.dataLength}),Ve.increment("api-calls",1),Ve.increment("buffer-data",this.size)}getBindGroup(e,t){return this.bindGroup||(this.bindGroup=G().getDevice().createBindGroup({layout:e.getBindGroupLayout(t),entries:[{binding:0,resource:{buffer:this.buffer}}]}),Ve.increment("api-calls",1)),this.bindGroup}getGpuUsage(){let e=GPUBufferUsage.COPY_DST;return this.usage===D.VERTEX&&(e|=GPUBufferUsage.VERTEX),this.usage===D.INDEX&&(e|=GPUBufferUsage.INDEX),this.usage===D.UNIFORM&&(e|=GPUBufferUsage.UNIFORM),e}getId(){return this.buffer}getSize(){return this.size}getUsage(){return this.usage}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(G().getDevice().queue.writeBuffer(this.buffer,e.offset??0,e.data,e.dataOffset,e.dataLength),Ve.increment("api-calls",1))}release(){this.buffer.destroy(),Ve.increment("buffer-data",-this.size),Ve.increment("api-calls",1),this.size=0}}class V extends z{allocate(e){const t=e.dynamic?this.context.DYNAMIC_DRAW:this.context.STATIC_DRAW;"size"===e.type?(this.size=e.size,this.context.bufferData(this.target,e.size,t)):(this.size=e.dataLength??e.data.byteLength,this.context.bufferData(this.target,e.data,t)),Ve.increment("api-calls",1)}getTarget(){switch(this.usage){case D.VERTEX:return this.context.ARRAY_BUFFER;case D.INDEX:return this.context.ELEMENT_ARRAY_BUFFER;case D.UNIFORM:throw new Error("Uniform buffers are not supported in WebGL 1")}}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(this.bind(),this.context.bufferSubData(this.target,e.offset??0,e.data),Ve.increment("api-calls",1))}}function W(e){return Ae()?new V(e):Pe()?new N(e):new O(e)}!function(e){e[e.VERTEX=1]="VERTEX",e[e.INDEX=2]="INDEX",e[e.UNIFORM=4]="UNIFORM"}(D||(D={}));class q{constructor(e){this.descriptor=e}getId(){return null}getDescriptor(){return this.descriptor}}class Y{constructor(e){this.descriptor=e,this.pipeline=G().getDevice().createRenderPipeline({vertex:{module:e.shader.getId(),buffers:e.vertexBuffers.map((e=>({arrayStride:e.stride,stepMode:e.isInstanced?"instance":"vertex",attributes:e.attributes.map((e=>({shaderLocation:e.index,offset:e.offset,format:this.getFormat(e.format)})))})))},fragment:{module:e.shader.getId(),targets:[{format:G().getCanvasFormat()}]},depthStencil:{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"},primitive:{cullMode:"back"},layout:"auto"}),Ve.increment("api-calls",1)}getId(){return this.pipeline}getDescriptor(){return this.descriptor}getFormat(e){switch(e){case M.FLOAT_1:return"float32";case M.FLOAT_2:return"float32x2";case M.FLOAT_3:return"float32x3";case M.FLOAT_4:return"float32x4"}}}!function(e){e[e.FLOAT_1=1]="FLOAT_1",e[e.FLOAT_2=2]="FLOAT_2",e[e.FLOAT_3=3]="FLOAT_3",e[e.FLOAT_4=4]="FLOAT_4"}(M||(M={}));class X{constructor(e,t){this.descriptor=e,this.pipeline=t}execute(){const e=this.descriptor.vertexBuffer,t=U().getId();t.bindBuffer(t.ARRAY_BUFFER,e.getId()),Ve.increment("api-calls",1);const i=this.pipeline.getDescriptor().vertexBuffers[this.descriptor.index];for(const e of i.attributes)t.vertexAttribPointer(e.index,this.getSize(e.format),t.FLOAT,!1,i.stride,e.offset+(this.descriptor.offset??0)),i.isInstanced&&(t.vertexAttribDivisor(e.index,1),Ve.increment("api-calls",1)),t.enableVertexAttribArray(e.index),Ve.increment("api-calls",2)}getSize(e){switch(e){case M.FLOAT_1:return 1;case M.FLOAT_2:return 2;case M.FLOAT_3:return 3;case M.FLOAT_4:return 4}}}class Q{constructor(e,t){this.descriptor=e,this.shader=t}execute(){const e=U().getId(),t=this.descriptor.uniformBuffer,i=this.shader,s=i.getUniformBlockIndex(this.descriptor.name);e.uniformBlockBinding(i.getId(),s,this.descriptor.index),e.bindBufferBase(e.UNIFORM_BUFFER,this.descriptor.index,t.getId()),Ve.increment("api-calls",2)}}class k{constructor(e){this.descriptor=e}execute(){const e=U().getId();e.drawElementsInstanced(e.TRIANGLES,this.descriptor.indexCount,e.UNSIGNED_SHORT,0,this.descriptor.instanceCount),Ve.increment("draw-calls",1),Ve.increment("rendered-instances",this.descriptor.instanceCount)}}class H{constructor(e){this.pipeline=e}execute(){const e=Pe()?U().getId():L().getId();e.useProgram(this.pipeline.getDescriptor().shader.getId()),e.viewport(0,0,window.innerWidth,window.innerHeight),e.clearColor(.7,.8,1,1),e.clear(e.COLOR_BUFFER_BIT),Ve.increment("api-calls",4)}}class ${constructor(e){this.indexBuffer=e}execute(){const e=Pe()?U().getId():L().getId();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer.getId()),Ve.increment("api-calls",1)}}class K{constructor(e,t){this.descriptor=e,this.shader=t}execute(){const e=Pe()?U().getId():L().getId(),t=this.shader.getUniformLocation(this.descriptor.name);this.setUniform(e,t),Ve.increment("api-calls",1)}}class j extends K{setUniform(e,t){e.uniform1f(t,this.descriptor.value)}}class J extends K{setUniform(e,t){e.uniform2fv(t,this.descriptor.value)}}class Z extends K{setUniform(e,t){e.uniform3fv(t,this.descriptor.value)}}class ee extends K{setUniform(e,t){e.uniform4fv(t,this.descriptor.value)}}class te extends K{setUniform(e,t){e.uniformMatrix2fv(t,!1,this.descriptor.value)}}class ie extends K{setUniform(e,t){e.uniformMatrix3fv(t,!1,this.descriptor.value)}}class se extends K{setUniform(e,t){e.uniformMatrix4fv(t,!1,this.descriptor.value)}}class ne{constructor(e){this.indexCount=e}execute(){const e=Pe()?U().getId():L().getId();e.drawElements(e.TRIANGLES,this.indexCount,e.UNSIGNED_SHORT,0),Ve.increment("draw-calls",1),Ve.increment("api-calls",1),Ve.increment("rendered-instances",1)}}class re{constructor(e){this.commands=[],this.query=e.query}addSetPipelineCommand(e){this.pipeline=e,this.commands.push(new H(e))}addSetIndexBufferCommand(e){this.commands.push(new $(e))}addSetUniformFloatCommand(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new j(e,t))}addSetUniformVec2Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new J(e,t))}addSetUniformVec3Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new Z(e,t))}addSetUniformVec4Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new ee(e,t))}addSetUniformMat2Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new te(e,t))}addSetUniformMat3Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new ie(e,t))}addSetUniformMat4Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new se(e,t))}addDrawIndexedCommand(e){this.commands.push(new ne(e))}addPushDebugGroup(){throw new Error("Debug groups are not supported in WebGL")}addPopDebugGroup(){throw new Error("Debug groups are not supported in WebGL")}addDebugLabel(){throw new Error("Debug labels are not supported in WebGL")}execute(){He.getCapabilities().gpuTimer&&this.query&&this.query.begin();for(const e of this.commands)e.execute();He.getCapabilities().gpuTimer&&this.query&&this.query.end(),He.getCapabilities().gpuTimer&&this.query&&this.query.update()}}class ae extends re{addSetVertexBufferCommand(e){this.commands.push(new X(e,this.pipeline))}addSetUniformBufferCommand(e){this.commands.push(new Q(e,this.pipeline.getDescriptor().shader))}addDrawInstancedIndexedCommand(e){this.commands.push(new k(e))}}class oe{constructor(e,t){this.pipeline=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.setPipeline(this.pipeline.getId()),Ve.increment("api-calls",1)}}class ce{constructor(e,t){this.descriptor=e,this.renderPassEncoder=t}execute(){const e=this.descriptor.vertexBuffer;this.renderPassEncoder.setVertexBuffer(this.descriptor.index,e.getId(),this.descriptor.offset??0),Ve.increment("api-calls",1)}}class le{constructor(e,t){this.indexBuffer=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.setIndexBuffer(this.indexBuffer.getId(),"uint16"),Ve.increment("api-calls",1)}}class he{constructor(e,t,i){this.descriptor=e,this.renderPassEncoder=t,this.pipeline=i}execute(){const e=this.descriptor.uniformBuffer.getBindGroup(this.pipeline.getId(),this.descriptor.index);this.renderPassEncoder.setBindGroup(this.descriptor.index,e),Ve.increment("api-calls",1)}}class ue{constructor(e,t){this.indexCount=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.drawIndexed(this.indexCount),Ve.increment("draw-calls",1),Ve.increment("api-calls",1),Ve.increment("rendered-instances",1)}}class de{constructor(e,t){this.descriptor=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.drawIndexed(this.descriptor.indexCount,this.descriptor.instanceCount),Ve.increment("draw-calls",1),Ve.increment("api-calls",1),Ve.increment("rendered-instances",this.descriptor.instanceCount)}}class me{constructor(e,t){this.label=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.pushDebugGroup(this.label),Ve.increment("api-calls",1)}}class ge{constructor(e){this.renderPassEncoder=e}execute(){this.renderPassEncoder.popDebugGroup(),Ve.increment("api-calls",1)}}class pe{constructor(e,t){this.label=e,this.renderPassEncoder=t}execute(){this.renderPassEncoder.insertDebugMarker(this.label),Ve.increment("api-calls",1)}}class fe{constructor(e){this.commands=[],this.query=e.query,this.label=e.label,this.commandEncoder=G().getDevice().createCommandEncoder({label:`${this.label} command encoder`}),this.renderPassEncoder=this.createRenderPassEncoder(this.commandEncoder),Ve.increment("api-calls",1)}createRenderPassEncoder(e){const t={label:`${this.label} render pass`,depthStencilAttachment:{view:G().getDepthView(),depthLoadOp:"clear",depthStoreOp:"store",depthReadOnly:!1,depthClearValue:1},colorAttachments:[{loadOp:"clear",clearValue:[.7,.8,1,1],storeOp:"store",view:G().getCurrentTexture().createView()}]};return He.getCapabilities().gpuTimer&&this.query&&(t.timestampWrites={querySet:this.query.getId(),beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}),Ve.increment("api-calls",2),e.beginRenderPass(t)}addSetPipelineCommand(e){this.pipeline=e,this.commands.push(new oe(e,this.renderPassEncoder))}addSetVertexBufferCommand(e){this.commands.push(new ce(e,this.renderPassEncoder))}addSetIndexBufferCommand(e){this.commands.push(new le(e,this.renderPassEncoder))}addSetUniformBufferCommand(e){const t=this.pipeline;this.commands.push(new he(e,this.renderPassEncoder,t))}addSetUniformFloatCommand(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformVec2Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformVec3Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformVec4Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformMat2Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformMat3Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addSetUniformMat4Command(){throw new Error("Individual uniforms are not supported in WebGPU")}addDrawIndexedCommand(e){this.commands.push(new ue(e,this.renderPassEncoder))}addDrawInstancedIndexedCommand(e){this.commands.push(new de(e,this.renderPassEncoder))}addPushDebugGroup(e){this.commands.push(new me(e,this.renderPassEncoder))}addPopDebugGroup(){this.commands.push(new ge(this.renderPassEncoder))}addDebugLabel(e){this.commands.push(new pe(e,this.renderPassEncoder))}execute(){for(const e of this.commands)e.execute();this.renderPassEncoder.end(),He.getCapabilities().gpuTimer&&this.query&&this.query.resolve(this.commandEncoder);const e=this.commandEncoder.finish({label:`${this.label} command buffer`});G().getDevice().queue.submit([e]),Ve.increment("api-calls",3),He.getCapabilities().gpuTimer&&this.query&&this.query.update()}}class xe{constructor(e,t){this.descriptor=e,this.pipeline=t}execute(){const e=this.descriptor.vertexBuffer,t=L().getId();t.bindBuffer(t.ARRAY_BUFFER,e.getId()),Ve.increment("api-calls",1);const i=this.pipeline.getDescriptor().vertexBuffers[this.descriptor.index];for(const e of i.attributes)t.vertexAttribPointer(e.index,this.getSize(e.format),t.FLOAT,!1,i.stride,e.offset+(this.descriptor.offset??0)),i.isInstanced&&(L().getInstancedRenderingExtension().vertexAttribDivisorANGLE(e.index,1),Ve.increment("api-calls",1)),t.enableVertexAttribArray(e.index),Ve.increment("api-calls",2)}getSize(e){switch(e){case M.FLOAT_1:return 1;case M.FLOAT_2:return 2;case M.FLOAT_3:return 3;case M.FLOAT_4:return 4}}}class Ee{constructor(e){this.descriptor=e}execute(){const e=L().getId();L().getInstancedRenderingExtension().drawElementsInstancedANGLE(e.TRIANGLES,this.descriptor.indexCount,e.UNSIGNED_SHORT,0,this.descriptor.instanceCount),Ve.increment("draw-calls",1),Ve.increment("api-calls",1),Ve.increment("rendered-instances",this.descriptor.instanceCount)}}class ve extends re{addSetVertexBufferCommand(e){this.commands.push(new xe(e,this.pipeline))}addSetUniformBufferCommand(){throw new Error("Uniform buffers are not supported in WebGL 1")}addDrawInstancedIndexedCommand(e){this.commands.push(new Ee(e))}}class be{constructor(){this.uniformLocations=new Map,this.context=Pe()?U().getId():L().getId();const e=this.getShader(this.context.VERTEX_SHADER,"#if __VERSION__ == 100\r\n attribute vec3 vertexPosition; attribute vec3 vertexNormal; attribute mat4 M; attribute vec3 color; varying vec3 vf_normal; varying vec3 vf_color; uniform mat4 VP;\r\n#else\r\n layout(location = 0) in vec3 vertexPosition; layout(location = 1) in vec3 vertexNormal; layout(location = 2) in mat4 M; layout(location = 6) in vec3 color; out vec3 vf_normal; out vec3 vf_color; layout(std140) uniform FrameData { mat4 VP; vec3 light; };\r\n#endif\r\nvoid main() { vf_normal = vertexNormal; vf_color = color; gl_Position = VP * M * vec4(vertexPosition, 1.0);}"),t=this.getShader(this.context.FRAGMENT_SHADER,"precision highp float;\r\n#if __VERSION__ == 100\r\n varying vec3 vf_normal; varying vec3 vf_color; uniform vec3 light;\r\n#else\r\n in vec3 vf_normal; in vec3 vf_color; layout(location = 0) out vec4 color; layout(std140) uniform FrameData { mat4 VP; vec3 light; };\r\n#endif\r\nvoid main() { vec3 N = normalize(vf_normal); vec3 L = light; vec3 result = vf_color * dot(N, -L);\r\n #if __VERSION__ == 100\r\n gl_FragColor = vec4(result, 1.0);\r\n #else\r\n color = vec4(result, 1.0);\r\n #endif\r\n}");this.program=this.context.createProgram(),this.setAttributeLocations(),this.context.attachShader(this.program,e),this.context.attachShader(this.program,t),this.context.linkProgram(this.program),this.context.deleteShader(e),this.context.deleteShader(t),Ve.increment("api-calls",6)}getId(){return this.program}getShader(e,t){const i=this.getShaderHeader()+t,s=this.context.createShader(e);return this.context.shaderSource(s,i),this.context.compileShader(s),Ve.increment("api-calls",3),s}getUniformLocation(e){let t=this.uniformLocations.get(e);return t||(t=this.context.getUniformLocation(this.program,e)??void 0,Ve.increment("api-calls",1),this.uniformLocations.set(e,t)),t}release(){this.context.deleteProgram(this.program),Ve.increment("api-calls",1)}}class Ce extends be{getShaderHeader(){return""}setAttributeLocations(){const e=L().getId();e.bindAttribLocation(this.program,0,"vertexPosition"),e.bindAttribLocation(this.program,1,"vertexNormal"),e.bindAttribLocation(this.program,2,"M"),e.bindAttribLocation(this.program,6,"color"),Ve.increment("api-calls",4)}}class we extends be{constructor(){super(...arguments),this.uniformBlockIndices=new Map}getShaderHeader(){return"#version 300 es\n"}setAttributeLocations(){}getUniformBlockIndex(e){const t=U().getId();let i=this.uniformBlockIndices.get(e);return null==i&&(i=t.getUniformBlockIndex(this.program,e),Ve.increment("api-calls",1),this.uniformBlockIndices.set(e,i)),i}}class Te{constructor(e){this.shaderModule=G().getDevice().createShaderModule({code:"struct Uniform{VP:mat4x4f,light:vec3f};@group(0)@binding(0)var<uniform>uni:Uniform;struct Vertex{@location(0)vertexPosition:vec3f,@location(1)vertexNormal:vec3f,@location(2)M1:vec4f,@location(3)M2:vec4f,@location(4)M3:vec4f,@location(5)M4:vec4f,@location(6)color:vec3f};struct Varying{@builtin(position)position:vec4f,@location(0)normal:vec3f,@location(1)color:vec3f};@vertex fn vertex(vertex:Vertex)->Varying{var v:Varying;let M=mat4x4f(vertex.M1,vertex.M2,vertex.M3,vertex.M4);v.position=uni.VP*M*vec4f(vertex.vertexPosition,1.0);v.normal=vertex.vertexNormal;v.color=vertex.color;return v;}@fragment fn fragment(v:Varying)->@location(0)vec4f{let N=normalize(v.normal);let L=uni.light;return vec4f(v.color*dot(N,-L),1.0);}",label:e.label}),Ve.increment("api-calls",1)}getId(){return this.shaderModule}async logCompilationInfo(){}getShaderModule(){return this.shaderModule}release(){}}class Se{constructor(e){this.inProgress=!1,this.handler=e.handler}update(){if(this.inProgress&&this.isResultAvailable()){const e=this.getResult();this.handler(w(e)),this.inProgress=!1}}}class Ie extends Se{constructor(e){super(e),this.gpuTimeExtension=L().getGpuTimeExtension(),this.query=this.gpuTimeExtension.createQueryEXT(),Ve.increment("api-calls",1)}getId(){return this.query}begin(){this.inProgress||(this.gpuTimeExtension.beginQueryEXT(this.gpuTimeExtension.TIME_ELAPSED_EXT,this.query),Ve.increment("api-calls",1))}end(){this.inProgress||(this.gpuTimeExtension.endQueryEXT(this.gpuTimeExtension.TIME_ELAPSED_EXT),Ve.increment("api-calls",1),this.inProgress=!0)}isResultAvailable(){return Ve.increment("api-calls",1),this.gpuTimeExtension.getQueryObjectEXT(this.query,this.gpuTimeExtension.QUERY_RESULT_AVAILABLE_EXT)}getResult(){return Ve.increment("api-calls",1),this.gpuTimeExtension.getQueryObjectEXT(this.query,this.gpuTimeExtension.QUERY_RESULT_EXT)}release(){this.gpuTimeExtension.deleteQueryEXT(this.query),Ve.increment("api-calls",1)}}class ye extends Se{constructor(e){super(e),this.context=U().getId(),this.query=this.context.createQuery(),Ve.increment("api-calls",1)}getId(){return this.query}begin(){this.inProgress||(this.context.beginQuery(U().getGpuTimeExtension().TIME_ELAPSED_EXT,this.query),Ve.increment("api-calls",1))}end(){this.inProgress||(this.context.endQuery(U().getGpuTimeExtension().TIME_ELAPSED_EXT),Ve.increment("api-calls",1),this.inProgress=!0)}isResultAvailable(){return Ve.increment("api-calls",1),this.context.getQueryParameter(this.query,this.context.QUERY_RESULT_AVAILABLE)}getResult(){return Ve.increment("api-calls",1),this.context.getQueryParameter(this.query,this.context.QUERY_RESULT)}release(){this.context.deleteQuery(this.query),Ve.increment("api-calls",1)}}class De{constructor(e){this.querySet=G().getDevice().createQuerySet({label:e.label,count:2,type:"timestamp"}),this.resolveQueryBufer=G().getDevice().createBuffer({label:"resolve query buffer",size:8*De.TIMESTAMP_COUNT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultQueryBuffer=G().getDevice().createBuffer({label:"result query buffer",size:8*De.TIMESTAMP_COUNT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),Ve.increment("api-calls",3),Ve.increment("buffer-data",16*De.TIMESTAMP_COUNT),this.handler=e.handler}getId(){return this.querySet}resolve(e){e.resolveQuerySet(this.querySet,0,2,this.resolveQueryBufer,0),Ve.increment("api-calls",1),"unmapped"===this.resultQueryBuffer.mapState&&(e.copyBufferToBuffer(this.resolveQueryBufer,0,this.resultQueryBuffer,0,this.resultQueryBuffer.size),Ve.increment("api-calls",1))}update(){"unmapped"===this.resultQueryBuffer.mapState&&(this.resultQueryBuffer.mapAsync(GPUMapMode.READ).then((()=>{const e=new BigInt64Array(this.resultQueryBuffer.getMappedRange()),t=w(Number(e[0])),i=w(Number(e[1]));this.handler(i-t),this.resultQueryBuffer.unmap(),Ve.increment("api-calls",2)})),Ve.increment("api-calls",1))}release(){this.querySet.destroy(),this.resolveQueryBufer.destroy(),this.resultQueryBuffer.destroy(),Ve.increment("buffer-data",-16*De.TIMESTAMP_COUNT),Ve.increment("api-calls",3)}}De.TIMESTAMP_COUNT=2;class Me{static updateMaxCellDistance(){const e=Oe.getCellSize()/2,t=e*e;Me.maxCellDistance=Math.sqrt(t+t)}static getMaxCellDistance(){return Me.maxCellDistance}constructor(e,t,i,s){this.x=0,this.z=0,this.scene=new Map,this.entityCount=0,this.valid=!1,this.instanceCount=0,this.vertexCount=0,this.triangleCount=0,this.cornerPoints=[],this.aabbMin=n(),this.aabbMax=n(),this.initialize(e,t,i,s)}initialize(e,t,i,s){this.x=i,this.z=s,this.entityCount=e.length,this.scene.clear();for(const i of t)this.scene.set(i,e.filter((e=>e.mesh===i.name)));this.instanceBuffer=this.createInstanceBuffer(),this.valid=!0,this.instanceCount=e.length,Ve.increment("instances",e.length),this.vertexCount=0,this.triangleCount=0;for(const[e,t]of this.scene)this.vertexCount+=e.vertexCount*t.length,this.triangleCount+=e.indexCount/3*t.length;if(Me.updateMaxCellDistance(),!this.cornerPoints.length)for(let e=0;e<8;e++)this.cornerPoints.push(d());Ve.increment("vertices",this.vertexCount),Ve.increment("triangles",this.triangleCount)}getX(){return this.x}getZ(){return this.z}isValid(){return this.valid}createInstanceBuffer(){return W({type:"data",data:this.createInstanceData(),usage:D.VERTEX})}createInstanceData(){const e=new Float32Array(19*this.entityCount);let t=0;for(const i of this.scene.values())this.addInstanceData(e,i,t),t+=i.length;return e}addInstanceData(e,t,i){for(let s=0;s<t.length;s++){const n=t[s],r=19*(s+i);u(Me.M,Me.defaultRotation,n.position,n.scale),e.set(Me.M,r),e.set(n.color,r+16)}}render(e,t,i){if(Oe.isFrustumCulling()&&!this.isInFrustum())return;Ve.increment("rendered-cells",1);let s=0;for(const[n,r]of this.scene)r.length&&(e.addSetVertexBufferCommand({vertexBuffer:t[n.vertexBufferIndex],index:0}),e.addSetVertexBufferCommand({vertexBuffer:this.instanceBuffer,index:1,offset:19*s*4}),e.addSetIndexBufferCommand(i[n.indexBufferIndex]),e.addDrawInstancedIndexedCommand({indexCount:n.indexCount,instanceCount:r.length}),Ve.increment("rendered-vertices",n.vertexCount*r.length),Ve.increment("rendered-triangles",n.indexCount/3*r.length),s+=r.length)}isInFrustum(){return this.computeCornerPointsInNdc(),this.computeAabbMin(),this.computeAabbMax(),this.aabbMin[0]<=1&&this.aabbMin[1]<=1&&this.aabbMin[2]<=1&&this.aabbMax[0]>=-1&&this.aabbMax[1]>=-1&&this.aabbMax[2]>=-1}computeCornerPointsInNdc(){const e=Oe.getCellSize()/2;this.worldSpaceToNdc(m(this.cornerPoints[0],this.x-e,0,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[1],this.x-e,e,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[2],this.x+e,e,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[3],this.x+e,0,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[4],this.x-e,0,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[5],this.x-e,e,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[6],this.x+e,e,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[7],this.x+e,0,this.z-e,1))}computeAabbMin(){a(this.aabbMin,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(const e of this.cornerPoints)this.aabbMin[0]=Math.min(this.aabbMin[0],e[0]),this.aabbMin[1]=Math.min(this.aabbMin[1],e[1]),this.aabbMin[2]=Math.min(this.aabbMin[2],e[2])}computeAabbMax(){a(this.aabbMax,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const e of this.cornerPoints)this.aabbMax[0]=Math.max(this.aabbMax[0],e[0]),this.aabbMax[1]=Math.max(this.aabbMax[1],e[1]),this.aabbMax[2]=Math.max(this.aabbMax[2],e[2])}worldSpaceToNdc(e){return function(e,t,i){var s=t[0],n=t[1],r=t[2],a=t[3];e[0]=i[0]*s+i[4]*n+i[8]*r+i[12]*a,e[1]=i[1]*s+i[5]*n+i[9]*r+i[13]*a,e[2]=i[2]*s+i[6]*n+i[10]*r+i[14]*a,e[3]=i[3]*s+i[7]*n+i[11]*r+i[15]*a}(e,e,Qe.getVP()),function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}(e,e,1/Math.abs(e[3]))}reset(){this.instanceBuffer.release(),this.instanceBuffer=this.createInstanceBuffer(),Me.updateMaxCellDistance()}release(){this.instanceBuffer.release(),Ve.increment("instances",-this.instanceCount),Ve.increment("vertices",-this.vertexCount),Ve.increment("triangles",-this.triangleCount);for(const e of this.scene.values()){S(e[0].color);for(const t of e)S(t.position),S(t.scale)}this.scene.clear(),this.valid=!1}}function Ae(){return He.getRenderingApi()===A.WEBGL_1}function Pe(){return He.getRenderingApi()===A.WEBGL_2}Me.M=h(),Me.defaultRotation=p(g(),0,0,0),Me.maxCellDistance=0,function(e){e[e.WEBGL_1=1]="WEBGL_1",e[e.WEBGL_2=2]="WEBGL_2",e[e.WEBGPU=3]="WEBGPU"}(A||(A={}));class Be{constructor(){this.restarted=!1,this.vertexBuffers=[],this.indexBuffers=[],this.meshes=[],this.lightDirection=n(),this.cells=[],this.cellsPool=[],this.capabilities={gpuTimer:!1,uniformBuffer:!1,instancedRendering:!1,isNdcCube:!0,debugGroups:!1}}getRenderingApi(){return this.renderingApi}getCapabilities(){return this.capabilities}getCanvas(){return this.canvas}getContext(){return this.context}async initialize(e){this.createCell=e,await this.initializeWithApi()}getApiList(){switch(Oe.getRenderingApi()){case y.WEBGPU:return[A.WEBGPU];case y.WEBGL_2:return[A.WEBGL_2];case y.WEBGL_1:return[A.WEBGL_1];default:return[A.WEBGPU,A.WEBGL_2,A.WEBGL_1]}}async initializeWithApi(e=this.getApiList()){this.canvas=this.getCanvasElement();for(const t of e)try{this.renderingApi=t,await this.createResources();for(const e of this.cells)e.reset();return}catch(e){continue}throw new Error("No rendering API is available")}async createResources(){if(this.context=await async function(){if(Ae()){const e=new F;return e.initialize(),e}if(Pe()){const e=new _;return e.initialize(),e}{const e=new R;return await e.initialize(),e}}(),!this.capabilities.instancedRendering)throw new Error("Instanced rendering is not supported");this.createPipeline(),this.createQuery(),this.createMeshes(),this.createUniformBuffer()}getCanvasElement(){const e=document.querySelector("canvas");if(!e)throw new Error("Couldn't find the canvas element");return e}addMesh(e,t,i,s,n){this.vertexBuffers.push(t),this.indexBuffers.push(i),this.meshes.push({name:e,vertexBufferIndex:this.vertexBuffers.length-1,indexBufferIndex:this.indexBuffers.length-1,vertexCount:s,indexCount:n})}createPipeline(){const e=(t={label:"default shader"},Ae()?new Ce:Pe()?new we:new Te(t));var t;this.pipeline=function(e){return Ae()||Pe()?new q(e):new Y(e)}({label:"default pipeline",shader:e,vertexBuffers:[{stride:24,isInstanced:!1,attributes:[{index:0,offset:0,format:M.FLOAT_3},{index:1,offset:12,format:M.FLOAT_3}]},{stride:76,isInstanced:!0,attributes:[{index:2,offset:0,format:M.FLOAT_4},{index:3,offset:16,format:M.FLOAT_4},{index:4,offset:32,format:M.FLOAT_4},{index:5,offset:48,format:M.FLOAT_4},{index:6,offset:64,format:M.FLOAT_3}]}]})}createQuery(){var e;this.capabilities.gpuTimer&&(this.query=(e={label:"gpu timer query",handler:e=>{Ne.addElapsedGpuTime(e)}},Ae()?new Ie(e):Pe()?new ye(e):new De(e)))}createMeshes(){!function(){const e=W({type:"data",data:new Float32Array([-.5,0,-.5,0,1,0,-.5,0,.5,0,1,0,.5,0,.5,0,1,0,.5,0,-.5,0,1,0]),usage:D.VERTEX,label:"Quad vertex buffer"}),t=W({type:"data",data:new Uint16Array([0,1,2,3,0,2]),usage:D.INDEX,label:"Quad index buffer"});He.addMesh("quad",e,t,4,6)}(),function(){const e=W({type:"data",data:new Float32Array([-.5,.5,.5,0,0,1,-.5,-.5,.5,0,0,1,.5,-.5,.5,0,0,1,.5,.5,.5,0,0,1,-.5,.5,-.5,-1,0,0,-.5,-.5,-.5,-1,0,0,-.5,-.5,.5,-1,0,0,-.5,.5,.5,-1,0,0,.5,.5,.5,1,0,0,.5,-.5,.5,1,0,0,.5,-.5,-.5,1,0,0,.5,.5,-.5,1,0,0,.5,.5,-.5,0,0,-1,.5,-.5,-.5,0,0,-1,-.5,-.5,-.5,0,0,-1,-.5,.5,-.5,0,0,-1,-.5,.5,-.5,0,1,0,-.5,.5,.5,0,1,0,.5,.5,.5,0,1,0,.5,.5,-.5,0,1,0,-.5,-.5,.5,0,-1,0,-.5,-.5,-.5,0,-1,0,.5,-.5,-.5,0,-1,0,.5,-.5,.5,0,-1,0]),usage:D.VERTEX,label:"Cube vertex buffer"}),t=W({type:"data",data:new Uint16Array([0,1,2,3,0,2,4,5,6,7,4,6,8,9,10,11,8,10,12,13,14,15,12,14,16,17,18,19,16,18,20,21,22,23,20,22]),usage:D.INDEX,label:"Cube index buffer"});He.addMesh("cube",e,t,24,36)}(),Ve.set("meshes",this.meshes.length)}createUniformBuffer(){if(this.capabilities.uniformBuffer){const e=4;this.uniformBuffer=W({type:"size",size:76+e,usage:D.UNIFORM,dynamic:!0})}this.uniformBufferData=new Float32Array(20)}async render(){this.clearPerFrameStatistics(),this.restarted&&await this.handleRestart(),this.handleResize();const e=(t={label:"default command buffer",query:this.query},Ae()?new ve(t):Pe()?new ae(t):new fe(t));var t;e.addSetPipelineCommand(this.pipeline),this.updateCells(e),this.updateUniforms(e),this.renderCells(e),e.execute()}async handleRestart(){await this.release();const e=this.canvas.cloneNode(!1);this.canvas.replaceWith(e),this.canvas=e,await this.initializeWithApi(),this.restarted=!1}handleResize(){this.canvas.width===window.innerWidth&&this.canvas.height===window.innerHeight||(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,Ye.update(),Qe.invalidate(),this.context.handleResize())}updateCells(e){this.removeCells(),this.addCells()}removeCells(){this.cells.filter((e=>!this.isCellInRange(e.getX(),e.getZ()))).forEach((e=>{e.release(),this.cellsPool.push(e)})),this.cells=this.cells.filter((e=>e.isValid()))}addCells(){const e=Oe.getCellSize(),t=Qe.getPosition(),i=Math.round(t[0]/e)*e,s=Math.round(t[2]/e)*e,n=I.getMaxFrustumDistance(),r=Math.round(n/e)+2;let a=0;for(let t=-r;t<=r;t++)for(let n=-r;n<=r;n++){const r=i+n*e,o=s+t*e,c=this.isCellInRange(r,o);if(this.cells.every((e=>e.getX()!==r||e.getZ()!==o))&&c){const e=this.getCell(r,o);this.cells.push(e)}this.updateCellsDebugger(a,n,t,r,o,c),a++}}getCell(e,t){if(this.cellsPool.length){const i=this.cellsPool.pop();return i.initialize(this.createCell(e,t),this.meshes,e,t),i}return new Me(this.createCell(e,t),this.meshes,e,t)}updateCellsDebugger(e,t,i,s,n,r){if(Oe.isCellsDebugger()){if(r){const t=this.cells.find((e=>e.getX()===s&&e.getZ()===n));t&&(Oe.isFrustumCulling()&&t.isInFrustum()?Ye.setCellState(e,"in-frustum"):Ye.setCellState(e,"in-range"))}else Ye.setCellState(e,"out-of-range");0===t&&0===i&&Ye.setCellState(e,"camera")}}renderCells(e){Ve.set("cells",this.cells.length);for(const t of this.cells)t.render(e,this.vertexBuffers,this.indexBuffers)}clearPerFrameStatistics(){Ve.set("api-calls",0),Ve.set("draw-calls",0),Ve.set("rendered-cells",0),Ve.set("rendered-instances",0),Ve.set("rendered-vertices",0),Ve.set("rendered-triangles",0)}updateUniforms(e){l(this.lightDirection,a(this.lightDirection,-1,-2,-3)),this.capabilities.uniformBuffer?(this.uniformBufferData.set(Qe.getVP(),0),this.uniformBufferData.set(this.lightDirection,16),this.uniformBuffer.setData({type:"buffer",data:this.uniformBufferData}),e.addSetUniformBufferCommand({index:0,name:"FrameData",uniformBuffer:this.uniformBuffer})):(e.addSetUniformMat4Command({name:"VP",value:Qe.getVP()}),e.addSetUniformVec3Command({name:"light",value:this.lightDirection}))}isCellInRange(e,t){const i=I.getMaxFrustumDistance(),s=Me.getMaxCellDistance(),n=Qe.getPosition(),r=e-n[0],a=t-n[2];return Math.sqrt(r*r+a*a)<=i+s}restart(){this.restarted=!0}removeAllCells(){for(const e of this.cells)e.release();this.cells.length=0}async release(){await this.context.stop(),this.capabilities.gpuTimer&&this.query?.release(),this.meshes.length=0;for(const e of this.vertexBuffers)e.release();this.vertexBuffers.length=0;for(const e of this.indexBuffers)e.release();this.indexBuffers.length=0,this.uniformBuffer?.release(),this.pipeline.getDescriptor().shader.release(),this.context.release()}}class Fe{constructor(){this.showingStatistics=!1,this.statisticsElement=C("#statistics"),this.renderingApiElement=C("#rendering-api"),this.fpsFrameTimeElement=C("#fps-frame-time"),this.cpuTimeElement=C("#cpu-time"),this.gpuTimeElement=C("#gpu-time"),this.apiCallsElement=C("#api-calls"),this.drawCallsElement=C("#draw-calls"),this.bufferDataElement=C("#buffer-data"),this.meshesElement=C("#meshes"),this.cellsElement=C("#cells"),this.renderedCellsElement=C("#rendered-cells"),this.instancesElement=C("#instances"),this.renderedInstancesElement=C("#rendered-instances"),this.verticesElement=C("#vertices"),this.renderedVerticesElement=C("#rendered-vertices"),this.trianglesElement=C("#triangles"),this.renderedTrianglesElement=C("#rendered-triangles")}update(){Oe.isStatistics()&&(this.showingStatistics||(this.statisticsElement.style.display="block",this.showingStatistics=!0),this.updateElements())}updateElements(){this.updateRenderingApi(),this.updateFpsFrameTime(),this.updateCpuTime(),this.updateGpuTime(),this.updateElement(this.apiCallsElement,"API calls","api-calls"),this.updateElement(this.drawCallsElement,"Draw calls","draw-calls"),this.updateBufferData(),this.updateElement(this.meshesElement,"Meshes","meshes"),this.updateElement(this.cellsElement,"Cells in range","cells"),this.updateElement(this.renderedCellsElement,"Rendered cells","rendered-cells"),this.updateElement(this.instancesElement,"Instances","instances"),this.updateElement(this.renderedInstancesElement,"Rendered instances","rendered-instances"),this.updateElement(this.verticesElement,"Vertices","vertices"),this.updateElement(this.renderedVerticesElement,"Rendered vertices","rendered-vertices"),this.updateElement(this.trianglesElement,"Triangles","triangles"),this.updateElement(this.renderedTrianglesElement,"Rendered triangles","rendered-triangles")}updateRenderingApi(){this.renderingApiElement.textContent=function(e){switch(e){case A.WEBGL_1:return"WebGL 1";case A.WEBGL_2:return"WebGL 2";case A.WEBGPU:return"WebGPU"}}(He.getRenderingApi())}updateFpsFrameTime(){const e=Ne.getFps(),t=(1/e*1e3).toFixed(2);this.fpsFrameTimeElement.textContent=`${e} FPS / ${t} ms`}updateCpuTime(){const e=Ne.getJsTime().toFixed(2);this.cpuTimeElement.textContent=`CPU time: ${e} ms`}updateGpuTime(){if(He.getCapabilities().gpuTimer){const e=Ne.getGpuTime().toFixed(2);this.gpuTimeElement.textContent=`GPU time: ${e} ms`}else this.gpuTimeElement.textContent=""}updateBufferData(){const e=(Ve.getValue("buffer-data")/1024/1024).toFixed(2);this.bufferDataElement.textContent=`Memory in buffers: ${e} MB`}updateElement(e,t,i){e.textContent=`${t}: ${Ve.get(i)}`}hide(){this.statisticsElement.style.display="none",this.showingStatistics=!1}}class _e{constructor(){this.dialog=C("dialog"),this.initializeOpenOptionsButton(),this.initializeCloseOptionsButton(),this.apiSelector=this.initializeApiSelector(),this.initializeFovY(),this.initializeViewDistance(),this.initializeCellSize(),this.initializeInstanceCount(),this.initializeStatistics(),this.initializeFrustumCulling(),this.initializeCellsDebugger()}initializeOpenOptionsButton(){C("#open-options-button").addEventListener("click",(()=>{this.dialog.showModal()}))}initializeCloseOptionsButton(){C("#close-options-button").addEventListener("click",(()=>{this.dialog.close()}))}initializeApiSelector(){const e=C("#rendering-api-selector");return e.value=Oe.getRenderingApi().toString(),e.addEventListener("change",(async()=>{Oe.setRenderingApi(+this.apiSelector.value)})),e}initializeFovY(){const e=C("#fovy-input");e.value=Oe.getFovY().toString(),e.addEventListener("change",(()=>{Oe.setFovY(+e.value)}))}initializeViewDistance(){const e=C("#view-distance-input");e.value=Oe.getViewDistance().toString(),e.addEventListener("change",(()=>{Oe.setViewDistance(+e.value)}))}initializeCellSize(){const e=C("#cell-size-input");e.value=Oe.getCellSize().toString(),e.addEventListener("change",(()=>{Oe.setCellSize(+e.value)}))}initializeInstanceCount(){const e=C("#instance-count-input");e.value=Oe.getInstanceCount().toString(),e.addEventListener("change",(()=>{Oe.setInstanceCount(+e.value)}))}initializeFrustumCulling(){const e=C("#frustum-culling-input");e.checked=Oe.isFrustumCulling(),e.addEventListener("change",(()=>{Oe.setFrustumCulling(e.checked)}))}initializeCellsDebugger(){const e=C("#cells-debugger-input");e.checked=Oe.isCellsDebugger(),Oe.isCellsDebugger()&&Ye.update(),e.addEventListener("change",(()=>{Oe.setCellsDebugger(e.checked)}))}initializeStatistics(){const e=C("#statistics-input");e.checked=Oe.isStatistics(),e.addEventListener("change",(()=>{Oe.setStatistics(e.checked)}))}getSelectedRenderingApi(){return Number.parseInt(this.apiSelector.value)}isDialogOpened(){return this.dialog.open}}class Re{constructor(){this.cellElements=[],this.grid=C("#cells-debugger")}update(){for(;this.grid.lastChild;)this.grid.removeChild(this.grid.lastChild);if(this.cellElements.length=0,!Oe.isCellsDebugger())return;const e=I.getMaxFrustumDistance(),t=2*(Math.round(e/Oe.getCellSize())+2)+1;this.grid.style.gridTemplateColumns=`repeat(${t}, 1fr)`,this.grid.style.gridTemplateRows=`repeat(${t}, 1fr)`,this.updateCells(t)}updateCells(e){const t=window.innerHeight/3/e;for(let i=0;i<e*e;i++){const e=document.createElement("div");e.style.width=`${t}px`,e.style.height=`${t}px`,this.grid.appendChild(e),this.cellElements.push(e)}}show(){this.grid.style.display="grid"}hide(){this.grid.style.display="none"}setCellState(e,t){this.cellElements[e].className=this.getClass(t)}getClass(e){switch(e){case"camera":return"camera-cell";case"in-frustum":return"in-frustum-cell";case"in-range":return"in-range-cell";case"out-of-range":return"out-of-range-cell"}}}class Le{constructor(){this.statistics=new Map}get(e){const t=this.statistics.get(e);return void 0===t?"-":t.toLocaleString()}getValue(e){return this.statistics.get(e)??0}set(e,t){this.statistics.set(e,t)}increment(e,t){const i=(this.statistics.get(e)??0)+t;this.set(e,i)}}class Ue{constructor(){this.startMoment=performance.now(),this.lastFrameEndMoment=this.startMoment,this.frameStartMoment=0,this.averageFps=0,this.frameCount=0,this.currentSecondFrameCount=0,this.lastFrameTime=0,this.frameTimeSum=0,this.averageJsTime=0,this.jsTimeSum=0,this.averageGpuTime=0,this.gpuTimeSum=0,this.gpuTimeCount=0,this.gpuSecondStartMoment=this.startMoment}addElapsedGpuTime(e){const t=performance.now();this.gpuTimeSum+=e,this.gpuTimeCount++,this.gpuSecondStartMoment+Ue.ONE_SECOND<t&&(this.averageGpuTime=this.gpuTimeSum/this.gpuTimeCount,this.gpuTimeSum=0,this.gpuTimeCount=0,this.gpuSecondStartMoment=t)}startFrame(){this.frameStartMoment=performance.now()}endFrame(){const e=performance.now();this.jsTimeSum+=e-this.frameStartMoment,this.lastFrameTime=e-this.lastFrameEndMoment,this.frameTimeSum+=this.lastFrameTime,this.lastFrameEndMoment=e,this.frameCount++,this.currentSecondFrameCount++,this.frameTimeSum>=Ue.ONE_SECOND&&(this.averageFps=Math.round(this.currentSecondFrameCount/this.frameTimeSum*Ue.ONE_SECOND),this.averageJsTime=this.jsTimeSum/this.currentSecondFrameCount,this.jsTimeSum=0,this.frameTimeSum=0,this.currentSecondFrameCount=0,We.update())}getDeltaTimeFactor(){return this.lastFrameTime}getFps(){return this.averageFps}getTimeInMillisecs(){return performance.now()-this.startMoment}getTimeInSecs(){return this.getTimeInMillisecs()/Ue.ONE_SECOND}getFrameCount(){return this.frameCount}getJsTime(){return this.averageJsTime}getGpuTime(){return this.averageGpuTime}}Ue.ONE_SECOND=1e3;class Ge{constructor(){this.keysDown=new Map,document.onkeydown=e=>{this.keysDown.set(e.code,e)},document.onkeyup=e=>{this.keysDown.delete(e.code)}}isKeyDown(e){return!qe.isDialogOpened()&&this.keysDown.has(e)}}class ze{constructor(){this.movement=n()}update(){const e=Ne.getDeltaTimeFactor();this.updateTranslation(e),this.updateRotation(e)}updateTranslation(e){const t=Xe.isKeyDown("ShiftLeft")?10:1,i=ze.MOVE_SPEED*e*t,s=Qe.getForward(),n=Qe.getRight();a(this.movement,0,0,0);let r=!1;Xe.isKeyDown("KeyA")&&(c(this.movement,this.movement,n),r=!0),Xe.isKeyDown("KeyD")&&(o(this.movement,this.movement,n),r=!0),Xe.isKeyDown("KeyW")&&(o(this.movement,this.movement,s),r=!0),Xe.isKeyDown("KeyS")&&(c(this.movement,this.movement,s),r=!0),r&&(function(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}(this.movement,l(this.movement,this.movement),i),Qe.move(this.movement))}updateRotation(e){const t=ze.ROTATION_SPEED*e;let i=0;Xe.isKeyDown("KeyQ")&&(i+=t),Xe.isKeyDown("KeyE")&&(i-=t),0!==i&&Qe.rotate(i)}}let Ne,Oe,Ve,We,qe,Ye,Xe,Qe,ke,He;async function $e(){try{console.log("This is a production build"),t=Array,Ne=new Ue,Oe=new P,Ve=new Le,We=new Fe,Ye=new Re,qe=new _e,Xe=new Ge,Qe=new I,ke=new ze,He=new Be,await He.initialize(Ke)}catch(e){console.error(e),await He.release()}await je()}function Ke(e,t){const i=[],s=Oe.getInstanceCount(),n=Oe.getCellSize();let r=T(Math.random(),Math.random(),Math.random());for(let a=0;a<s;a++){const s={position:T(e+Math.random()*n-n/2,.5,t+Math.random()*-n+n/2),scale:T(1,1,1),mesh:"cube",color:r};i.push(s)}return r=T(Math.random(),Math.random(),Math.random()),i.push({position:T(e,0,t),scale:T(n,1,n),mesh:"quad",color:r}),i}async function je(){Ne.startFrame(),ke.update(),await He.render(),Ne.endFrame(),requestAnimationFrame((async()=>{await je()}))}ze.MOVE_SPEED=.025,ze.ROTATION_SPEED=.075,$e()})();