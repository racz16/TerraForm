(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{nS:()=>rt,Wc:()=>st,qH:()=>nt,DH:()=>ct,YM:()=>Ze,Vq:()=>it,n6:()=>ot,hd:()=>et,cM:()=>tt,XV:()=>Je});var t="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;var i=Math.PI/180;function s(e){return e*i}function n(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(e,i,s){var n=new t(3);return n[0]=e,n[1]=i,n[2]=s,n}function a(e,t,i,s){return e[0]=t,e[1]=i,e[2]=s,e}function o(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function c(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function l(e,t){var i=t[0],s=t[1],n=t[2],r=i*i+s*s+n*n;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});function h(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function u(e,t,i,s){var n=t[0],r=t[1],a=t[2],o=t[3],c=n+n,l=r+r,h=a+a,u=n*c,d=n*l,m=n*h,p=r*l,g=r*h,f=a*h,x=o*c,v=o*l,E=o*h,b=s[0],C=s[1],T=s[2];return e[0]=(1-(p+f))*b,e[1]=(d+E)*b,e[2]=(m-v)*b,e[3]=0,e[4]=(d-E)*C,e[5]=(1-(u+f))*C,e[6]=(g+x)*C,e[7]=0,e[8]=(m+v)*T,e[9]=(g-x)*T,e[10]=(1-(u+p))*T,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}n();function d(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function m(e,t,i,s,n){return e[0]=t,e[1]=i,e[2]=s,e[3]=n,e}function p(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function g(e,t,i,s){var n=.5*Math.PI/180;t*=n,i*=n,s*=n;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(i),c=Math.cos(i),l=Math.sin(s),h=Math.cos(s);return e[0]=r*c*h-a*o*l,e[1]=a*o*h+r*c*l,e[2]=a*c*l-r*o*h,e[3]=a*c*h+r*o*l,e}d();var f;n(),r(1,0,0),r(0,1,0),p(),p(),f=new t(9),t!=Float32Array&&(f[1]=0,f[2]=0,f[3]=0,f[5]=0,f[6]=0,f[7]=0),f[0]=1,f[4]=1,f[8]=1;const x=new ArrayBuffer(64),v=function(){const e=[];for(let t=1;t<=16;t++)e.push(new Float32Array(x,0,t));return e}(),E=[];function b(e){const t=e,i=v[t.length-1];return i.set(t),i}function C(e){return document.querySelector(e)}function T(e){return e/1e3/1e3}function w(e,t,i){const s=E.pop();return s?a(s,e,t,i):r(e,t,i)}function I(e){E.push(e)}class y{static getMaxFrustumDistance(){return this.maxFrustumDistance}static updateMaxFrustumDistance(){const e=function(e,t){if(!t){const e=ot.getCanvas();t=e.clientWidth/e.clientHeight}return 2*Math.atan(Math.tan(.5*s(e))*t)}(Ze.getFovY());this.maxFrustumDistance=Ze.getViewDistance()/Math.cos(e/2)}constructor(){this.position=r(0,5,15),this.rotation=0,this.R=h(),this.q=p(),this.tempVec=n(),this.V=h(),this.P=h(),this.VP=h(),this.forward=n(),this.right=n(),this.valid=!1,y.updateMaxFrustumDistance()}getPosition(){return this.position}move(e){o(this.position,this.position,e),this.valid=!1}getRotation(){return this.rotation}rotate(e){this.rotation+=e,this.valid=!1}getVP(){return this.valid||(this.update(),this.valid=!0),this.VP}getForward(){return this.valid||(this.update(),this.valid=!0),this.forward}getRight(){return this.valid||(this.update(),this.valid=!0),this.right}update(){this.updateV(),this.updateP(),function(e,t,i){var s=t[0],n=t[1],r=t[2],a=t[3],o=t[4],c=t[5],l=t[6],h=t[7],u=t[8],d=t[9],m=t[10],p=t[11],g=t[12],f=t[13],x=t[14],v=t[15],E=i[0],b=i[1],C=i[2],T=i[3];e[0]=E*s+b*o+C*u+T*g,e[1]=E*n+b*c+C*d+T*f,e[2]=E*r+b*l+C*m+T*x,e[3]=E*a+b*h+C*p+T*v,E=i[4],b=i[5],C=i[6],T=i[7],e[4]=E*s+b*o+C*u+T*g,e[5]=E*n+b*c+C*d+T*f,e[6]=E*r+b*l+C*m+T*x,e[7]=E*a+b*h+C*p+T*v,E=i[8],b=i[9],C=i[10],T=i[11],e[8]=E*s+b*o+C*u+T*g,e[9]=E*n+b*c+C*d+T*f,e[10]=E*r+b*l+C*m+T*x,e[11]=E*a+b*h+C*p+T*v,E=i[12],b=i[13],C=i[14],T=i[15],e[12]=E*s+b*o+C*u+T*g,e[13]=E*n+b*c+C*d+T*f,e[14]=E*r+b*l+C*m+T*x,e[15]=E*a+b*h+C*p+T*v}(this.VP,this.P,this.V)}updateV(){!function(e,t){var i=t[0],s=t[1],n=t[2],r=t[3],a=i+i,o=s+s,c=n+n,l=i*a,h=s*a,u=s*o,d=n*a,m=n*o,p=n*c,g=r*a,f=r*o,x=r*c;e[0]=1-u-p,e[1]=h+x,e[2]=d-f,e[3]=0,e[4]=h-x,e[5]=1-l-p,e[6]=m+g,e[7]=0,e[8]=d+f,e[9]=m-g,e[10]=1-l-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this.R,g(this.q,0,-this.rotation,0)),function(e,t,i){var s,n,r,a,o,c,l,h,u,d,m,p,g=i[0],f=i[1],x=i[2];t===e?(e[12]=t[0]*g+t[4]*f+t[8]*x+t[12],e[13]=t[1]*g+t[5]*f+t[9]*x+t[13],e[14]=t[2]*g+t[6]*f+t[10]*x+t[14],e[15]=t[3]*g+t[7]*f+t[11]*x+t[15]):(s=t[0],n=t[1],r=t[2],a=t[3],o=t[4],c=t[5],l=t[6],h=t[7],u=t[8],d=t[9],m=t[10],p=t[11],e[0]=s,e[1]=n,e[2]=r,e[3]=a,e[4]=o,e[5]=c,e[6]=l,e[7]=h,e[8]=u,e[9]=d,e[10]=m,e[11]=p,e[12]=s*g+o*f+u*x+t[12],e[13]=n*g+c*f+d*x+t[13],e[14]=r*g+l*f+m*x+t[14],e[15]=a*g+h*f+p*x+t[15])}(this.V,this.R,function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}(this.tempVec,this.position)),a(this.forward,this.R[8],this.R[9],-this.R[10]),a(this.right,this.R[0],this.R[1],-this.R[2])}updateP(){const e=s(Ze.getFovY()),t=ot.getCanvas(),i=t.clientWidth/t.clientHeight,n=Ze.getViewDistance();ot.getCapabilities().isNdcCube?function(e,t,i,s,n){var r,a=1/Math.tan(t/2);e[0]=a/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(r=1/(s-n),e[10]=(n+s)*r,e[14]=2*n*s*r):(e[10]=-1,e[14]=-2*s)}(this.P,e,i,.5,n):function(e,t,i,s,n){var r,a=1/Math.tan(t/2);e[0]=a/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(r=1/(.5-n),e[10]=n*r,e[14]=.5*n*r):(e[10]=-1,e[14]=-.5)}(this.P,e,i,0,n)}invalidate(){this.valid=!1}}var D,S,_,A;y.maxFrustumDistance=0,function(e){e[e.AUTO=0]="AUTO",e[e.WEBGL_1=1]="WEBGL_1",e[e.WEBGL_2=2]="WEBGL_2",e[e.WEBGPU=3]="WEBGPU"}(D||(D={}));class B{constructor(){this.renderingApi=D.AUTO,this.fovY=50,this.viewDistance=500,this.cellSize=100,this.instanceCount=100,this.statistics=!1,this.frustumCulling=!0,this.cellsDebugger=!1,this.loadApi(),this.loadStatistics(),this.loadFrustumCulling(),this.loadCellsDebugger(),this.loadFovY(),this.loadViewDistance(),this.loadCellSize(),this.loadInstanceCount()}loadApi(){const e=localStorage.getItem("renderingApi");if(null==e)return;const t=Number.parseInt(e);t!==D.AUTO&&t!==D.WEBGL_1&&t!==D.WEBGL_2&&t!==D.WEBGPU||(this.renderingApi=t)}loadStatistics(){const e=localStorage.getItem("statistics");null!=e&&(this.statistics="true"===e)}loadFrustumCulling(){const e=localStorage.getItem("frustumCulling");null!=e&&(this.frustumCulling="true"===e)}loadCellsDebugger(){const e=localStorage.getItem("cellsDebugger");null!=e&&(this.cellsDebugger="true"===e)}loadFovY(){const e=localStorage.getItem("fovY");null!=e&&(this.fovY=Math.min(Math.max(1,+e),179))}loadViewDistance(){const e=localStorage.getItem("viewDistance");null!=e&&(this.viewDistance=Math.max(+e,1))}loadCellSize(){const e=localStorage.getItem("cellSize");null!=e&&(this.cellSize=Math.max(+e,1))}loadInstanceCount(){const e=localStorage.getItem("instanceCount");null!=e&&(this.instanceCount=Math.max(+e,0))}getRenderingApi(){return this.renderingApi}setRenderingApi(e){this.renderingApi=e,localStorage.setItem("renderingApi",this.renderingApi.toString()),ot.restart(),rt.invalidate()}isStatistics(){return this.statistics}setStatistics(e){this.statistics=e,localStorage.setItem("statistics",this.statistics.toString()),e||tt.hide()}isFrustumCulling(){return this.frustumCulling}setFrustumCulling(e){this.frustumCulling=e,localStorage.setItem("frustumCulling",this.frustumCulling.toString())}isCellsDebugger(){return this.cellsDebugger}setCellsDebugger(e){this.cellsDebugger=e,localStorage.setItem("cellsDebugger",this.cellsDebugger.toString()),st.update(),e?st.show():st.hide()}getFovY(){return this.fovY}setFovY(e){this.fovY=e,localStorage.setItem("fovY",this.fovY.toString()),y.updateMaxFrustumDistance(),st.update(),rt.invalidate()}getViewDistance(){return this.viewDistance}setViewDistance(e){this.viewDistance=e,localStorage.setItem("viewDistance",this.viewDistance.toString()),y.updateMaxFrustumDistance(),st.update(),rt.invalidate()}getCellSize(){return this.cellSize}setCellSize(e){this.cellSize=e,localStorage.setItem("cellSize",this.cellSize.toString()),ot.removeAllCells(),st.update()}getInstanceCount(){return this.instanceCount}setInstanceCount(e){this.instanceCount=e,localStorage.setItem("instanceCount",this.instanceCount.toString()),ot.removeAllCells(),st.update()}}class F{initializeShared(e){this.context=this.createContext(),this.context.enable(this.context.DEPTH_TEST),this.context.enable(this.context.CULL_FACE),et.increment("api-calls",2),ot.getCapabilities().isNdcCube=!0,ot.getCapabilities().instanceOffset=!1,this.capabilitiesAndExtensions()}getContext(e){const t=ot.getCanvas().getContext(e,{powerPreference:"high-performance",depth:!1,antialias:!1});return et.increment("api-calls",1),ot.getCanvas().addEventListener("webglcontextlost",(e=>{console.log("WebGL context lost",e),ct()})),t}getId(){return this.context}async stop(){this.context.flush(),et.increment("api-calls",1)}release(){}}class M extends F{constructor(){super(...arguments),this.gl1GpuTimeExtension=null,this.gl1InstancedRenderingExtension=null,this.gl1DepthTexture=null}initialize(){this.initializeShared("WebGL 1")}getId(){return this.context}capabilitiesAndExtensions(){this.gl1GpuTimeExtension=this.context.getExtension("EXT_disjoint_timer_query"),this.gl1InstancedRenderingExtension=this.context.getExtension("ANGLE_instanced_arrays"),this.gl1DepthTexture=this.context.getExtension("WEBGL_depth_texture"),et.increment("api-calls",3);let e=0;this.gl1GpuTimeExtension&&(e=this.gl1GpuTimeExtension.getQueryEXT(this.gl1GpuTimeExtension.TIME_ELAPSED_EXT,this.gl1GpuTimeExtension.QUERY_COUNTER_BITS_EXT),et.increment("api-calls",1)),ot.getCapabilities().uniformBuffer=!1,ot.getCapabilities().gpuTimer=!(!this.gl1GpuTimeExtension||!e),ot.getCapabilities().instancedRendering=!!this.gl1InstancedRenderingExtension,ot.getCapabilities().debugGroups=!1,ot.getCapabilities().depthTexture=!!this.gl1DepthTexture,ot.getCapabilities().uvUp=!0}createContext(){const e=this.getContext("webgl")||this.getContext("webgl-experimental");if(!e)throw new Error("Couldn't create a WebGL 1 context");return e}getGpuTimeExtension(){return this.gl1GpuTimeExtension}getInstancedRenderingExtension(){return this.gl1InstancedRenderingExtension}getDepthTextureExtension(){return this.gl1DepthTexture}}class R extends F{constructor(){super(...arguments),this.gl2GpuTimeExtension=null}initialize(){this.initializeShared("WebGL 2")}getGpuTimeExtension(){return this.gl2GpuTimeExtension}getId(){return this.context}capabilitiesAndExtensions(){this.gl2GpuTimeExtension=this.context.getExtension("EXT_disjoint_timer_query_webgl2"),et.increment("api-calls",1);let e=0;this.gl2GpuTimeExtension&&(e=this.context.getQuery(this.gl2GpuTimeExtension.TIME_ELAPSED_EXT,this.gl2GpuTimeExtension.QUERY_COUNTER_BITS_EXT),et.increment("api-calls",1)),ot.getCapabilities().uniformBuffer=!0,ot.getCapabilities().gpuTimer=!(!this.gl2GpuTimeExtension||!e),ot.getCapabilities().instancedRendering=!0,ot.getCapabilities().debugGroups=!1,ot.getCapabilities().depthTexture=!0,ot.getCapabilities().uvUp=!0}createContext(){const e=this.getContext("webgl2");if(!e)throw new Error("Couldn't create a WebGL 2 context");return e}}class P{constructor(){this.deviceLostCount=0}async initialize(){this.checkWebGPUSupport();const e=await this.getAdapter();this.device=await this.createDevice(e),this.context=this.getContext(),ot.getCapabilities().isNdcCube=!1,ot.getCapabilities().uniformBuffer=!0,ot.getCapabilities().instancedRendering=!0,ot.getCapabilities().debugGroups=!0,ot.getCapabilities().instanceOffset=!0,ot.getCapabilities().depthTexture=!0,ot.getCapabilities().uvUp=!1}getId(){return this.context}getCanvasFormat(){return this.canvasFormat}getDevice(){return this.device}getCurrentTexture(){return et.increment("api-calls",1),this.context.getCurrentTexture()}checkWebGPUSupport(){if(!navigator.gpu)throw new Error("WebGPU isn't supported")}async getAdapter(){const e=await navigator.gpu.requestAdapter({powerPreference:"high-performance"});if(et.increment("api-calls",1),!e||e.isFallbackAdapter)throw new Error("Couldn't get an adapter");return e}async logAdapterInfo(e){}async createDevice(e){const t=this.createDeviceDescriptor(e),i=await e.requestDevice(t);return et.increment("api-calls",1),i.lost.then((e=>{"destroyed"!==e.reason&&(console.error("Device lost"),console.error(`Reason: ${e.reason}`),console.error(`Message: ${e.message}`),this.deviceLostCount++,this.deviceLostCount<=5&&ct())})),i}createDeviceDescriptor(e){const t={},i="timestamp-query";return ot.getCapabilities().gpuTimer=e.features.has(i),ot.getCapabilities().gpuTimer&&(t.requiredFeatures=[i]),t}logDeviceInfo(e){}getContext(){const e=ot.getCanvas().getContext("webgpu");if(!e)throw new Error("Couldn't create a WebGPU context");return this.canvasFormat=navigator.gpu.getPreferredCanvasFormat(),e.configure({format:this.canvasFormat,device:this.device}),et.increment("api-calls",3),e}async stop(){await this.device.queue.onSubmittedWorkDone(),et.increment("api-calls",1)}release(){this.context?.unconfigure(),this.device?.destroy(),et.increment("api-calls",3)}}function U(){return ot.getContext()}function G(){return ot.getContext()}function L(){return ot.getContext()}class N{constructor(e){this.size=0,this.context=qe()?G().getId():U().getId(),this.size=this.computeSize(e),this.usage=e.usage,this.target=this.getTarget(),this.id=this.context.createBuffer(),et.increment("api-calls",1),this.bind(),this.initializeBufferData(e),et.increment("buffer-data",this.size)}computeSize(e){return"size"===e.type||"data-callback"===e.type?e.size:e.dataLength??e.data.byteLength}getId(){return this.id}bind(){this.context.bindBuffer(this.target,this.id),et.increment("api-calls",1)}getSize(){return this.size}getUsage(){return this.usage}release(){this.context.deleteBuffer(this.id),et.increment("api-calls",1),et.increment("buffer-data",-this.size),this.size=0}}class O extends N{initializeBufferData(e){const t=e.dynamic?this.context.DYNAMIC_DRAW:this.context.STATIC_DRAW;if("size"===e.type)this.context.bufferData(this.target,e.size,t);else if("data-callback"===e.type){const i=new ArrayBuffer(this.size);e.callback(i),this.context.bufferData(this.target,i,t)}else this.context.bufferData(this.target,e.data,t,e.dataOffset??0,e.dataLength);et.increment("api-calls",1)}getTarget(){switch(this.usage){case S.VERTEX:return this.context.ARRAY_BUFFER;case S.INDEX:return this.context.ELEMENT_ARRAY_BUFFER;case S.UNIFORM:return this.context.UNIFORM_BUFFER}}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(this.bind(),this.context.bufferSubData(this.target,e.offset??0,e.data,e.dataOffset??0,e.dataLength),et.increment("api-calls",1))}}class z{constructor(e){this.bindGroup=null,this.usage=e.usage,this.size=this.computeSize(e),this.buffer=this.createBuffer(e),this.initializeBufferData(e),et.increment("api-calls",1),et.increment("buffer-data",this.size)}computeSize(e){return"size"===e.type||"data-callback"===e.type?e.size:e.dataLength??e.data.byteLength}createBuffer(e){const t={size:this.size,usage:this.getGpuUsage(),label:e.label,mappedAtCreation:"data-callback"===e.type};return L().getDevice().createBuffer(t)}initializeBufferData(e){if("data"===e.type)this.setData({type:"buffer",data:e.data,dataOffset:e.dataOffset,dataLength:e.dataLength});else if("data-callback"===e.type){const t=this.buffer.getMappedRange();e.callback(t),this.buffer.unmap(),et.increment("api-calls",2)}}getBindGroup(e,t){return this.bindGroup||(this.bindGroup=L().getDevice().createBindGroup({layout:e.getBindGroupLayout(t),entries:[{binding:0,resource:{buffer:this.buffer}}]}),et.increment("api-calls",1)),this.bindGroup}getGpuUsage(){let e=GPUBufferUsage.COPY_DST;return this.usage===S.VERTEX&&(e|=GPUBufferUsage.VERTEX),this.usage===S.INDEX&&(e|=GPUBufferUsage.INDEX),this.usage===S.UNIFORM&&(e|=GPUBufferUsage.UNIFORM),e}getId(){return this.buffer}getSize(){return this.size}getUsage(){return this.usage}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(L().getDevice().queue.writeBuffer(this.buffer,e.offset??0,e.data,e.dataOffset,e.dataLength),et.increment("api-calls",1))}release(){this.buffer.destroy(),et.increment("buffer-data",-this.size),et.increment("api-calls",1),this.size=0}}class V extends N{initializeBufferData(e){const t=e.dynamic?this.context.DYNAMIC_DRAW:this.context.STATIC_DRAW;if("size"===e.type)this.context.bufferData(this.target,e.size,t);else if("data-callback"===e.type){const i=new ArrayBuffer(this.size);e.callback(i),this.context.bufferData(this.target,i,t)}else this.context.bufferData(this.target,e.data,t);et.increment("api-calls",1)}getTarget(){switch(this.usage){case S.VERTEX:return this.context.ARRAY_BUFFER;case S.INDEX:return this.context.ELEMENT_ARRAY_BUFFER;case S.UNIFORM:throw new Error("Uniform buffers are not supported in WebGL 1")}}setData(e){"math"===e.type?this.setData({type:"buffer",data:b(e.data),offset:e.offset}):(this.bind(),this.context.bufferSubData(this.target,e.offset??0,e.data),et.increment("api-calls",1))}}function W(e){return We()?new V(e):qe()?new O(e):new z(e)}!function(e){e[e.VERTEX=1]="VERTEX",e[e.INDEX=2]="INDEX",e[e.UNIFORM=4]="UNIFORM"}(S||(S={}));class q{constructor(e,t){this.pipeline=e,this.renderpass=t}execute(){this.renderpass.getEncoder().setPipeline(this.pipeline.getId()),et.increment("api-calls",1)}}class X{constructor(e,t){this.descriptor=e,this.renderpass=t}execute(){const e=this.descriptor.vertexBuffer;this.renderpass.getEncoder().setVertexBuffer(this.descriptor.index,e.getId(),this.descriptor.offset??0),et.increment("api-calls",1)}}class k{constructor(e,t){this.indexBuffer=e,this.renderpass=t}execute(){this.renderpass.getEncoder().setIndexBuffer(this.indexBuffer.getId(),"uint16"),et.increment("api-calls",1)}}class Q{constructor(e,t,i){this.descriptor=e,this.renderpass=t,this.pipeline=i}execute(){const e=this.descriptor.value.getBindGroup(this.pipeline.getId(),this.descriptor.index);this.renderpass.getEncoder().setBindGroup(this.descriptor.index,e),et.increment("api-calls",1)}}class Y{constructor(e,t,i){this.descriptor=e,this.renderpass=t,this.pipeline=i}execute(){const e=this.descriptor.value.getBindGroup(this.pipeline.getId(),this.descriptor.index);this.renderpass.getEncoder().setBindGroup(this.descriptor.index,e),et.increment("api-calls",1)}}class H{constructor(e,t){this.indexCount=e,this.renderpass=t}execute(){this.renderpass.getEncoder().drawIndexed(this.indexCount),et.increment("draw-calls",1),et.increment("api-calls",1),et.increment("rendered-instances",1)}}class ${constructor(e,t){this.descriptor=e,this.renderpass=t}execute(){this.renderpass.getEncoder().drawIndexed(this.descriptor.indexCount,this.descriptor.instanceCount,0,0,this.descriptor.instanceOffset),et.increment("draw-calls",1),et.increment("api-calls",1),et.increment("rendered-instances",this.descriptor.instanceCount)}}class K{constructor(e,t){this.label=e,this.renderpass=t}execute(){this.renderpass.getEncoder().pushDebugGroup(this.label),et.increment("api-calls",1)}}class j{constructor(e){this.renderpass=e}execute(){this.renderpass.getEncoder().popDebugGroup(),et.increment("api-calls",1)}}class J{constructor(e,t){this.label=e,this.renderpass=t}execute(){this.renderpass.getEncoder().insertDebugMarker(this.label),et.increment("api-calls",1)}}class Z{constructor(e,t){this.commands=[],this.commandEncoder=t,this.query=e.query,this.label=e.label,this.descriptor=e}createRenderPassEncoder(e,t){const i=e.depthStencilAttachment,s={label:`${this.label} renderpass`,depthStencilAttachment:i?{view:i.texture.getId().createView(),depthLoadOp:i.clearValue?"clear":"load",depthClearValue:i.clearValue,depthStoreOp:"store"}:void 0,colorAttachments:this.getColorAttachments(e)};return ot.getCapabilities().gpuTimer&&this.query&&(s.timestampWrites={querySet:this.query.getId(),beginningOfPassWriteIndex:0,endOfPassWriteIndex:1}),et.increment("api-calls",2),t.beginRenderPass(s)}getColorAttachments(e){return"canvas"===e.type?[{loadOp:e.clearColor?"clear":"load",clearValue:e.clearColor,storeOp:"store",view:L().getCurrentTexture().createView()}]:e.colorAttachments.map((e=>({loadOp:e.clearColor?"clear":"load",clearValue:e.clearColor,storeOp:"store",view:e.texture.getView()})))}setPipelineCommand(e){this.pipeline=e,this.commands.push(new q(e,this))}setVertexBufferCommand(e){this.commands.push(new X(e,this))}setIndexBufferCommand(e){this.commands.push(new k(e,this))}setUniformBufferCommand(e){const t=this.pipeline;this.commands.push(new Q(e,this,t))}setUniformFloatCommand(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformVec2Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformVec3Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformVec4Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformMat2Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformMat3Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformMat4Command(){throw new Error("Individual uniforms are not supported in WebGPU")}setUniformTextureCommand(e){const t=this.pipeline;this.commands.push(new Y(e,this,t))}drawIndexedCommand(e){this.commands.push(new H(e,this))}drawInstancedIndexedCommand(e){this.commands.push(new $(e,this))}pushDebugGroupCommand(e){this.commands.push(new K(e,this))}popDebugGroupCommand(){this.commands.push(new j(this))}addDebugLabelCommand(e){this.commands.push(new J(e,this))}getEncoder(){return this.renderPassEncoder}updateQuery(){this.query?.update()}execute(){this.renderPassEncoder=this.createRenderPassEncoder(this.descriptor,this.commandEncoder);for(const e of this.commands)e.execute();this.renderPassEncoder.end(),ot.getCapabilities().gpuTimer&&this.query&&this.query.resolve(this.commandEncoder),et.increment("api-calls",1)}}class ee{constructor(e){this.renderpasses=[],this.label=e,this.commandEncoder=L().getDevice().createCommandEncoder({label:`${this.label} command encoder`}),et.increment("api-calls",1)}createRenderpass(e){const t=new Z(e,this.commandEncoder);return this.renderpasses.push(t),t}execute(){for(const e of this.renderpasses)e.execute();const e=this.commandEncoder.finish({label:this.label});if(L().getDevice().queue.submit([e]),et.increment("api-calls",2),ot.getCapabilities().gpuTimer)for(const e of this.renderpasses)e.updateQuery()}}class te{constructor(e){this.descriptor=e}execute(){const e=qe()?G().getId():U().getId(),t=ot.getCanvas();if(e.viewport(0,0,t.clientWidth,t.clientHeight),et.increment("api-calls",1),"canvas"===this.descriptor.type)e.bindFramebuffer(e.FRAMEBUFFER,null),et.increment("api-calls",1);else{const t=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);for(let t=0;t<this.descriptor.colorAttachments.length;t++){const i=this.descriptor.colorAttachments[t];if(e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,i.texture.getId(),0),et.increment("api-calls",1),i.clearColor){const s=i.clearColor;if(We())e.clearColor(s[0],s[1],s[2],s[3]),e.clear(e.COLOR_BUFFER_BIT),et.increment("api-calls",2);else{const e=G().getId();e.clearBufferfv(e.COLOR,t,s),et.increment("api-calls",1)}}}this.descriptor.depthStencilAttachment&&(e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.descriptor.depthStencilAttachment.texture.getId(),0),et.increment("api-calls",1),this.descriptor.depthStencilAttachment.clearValue&&(e.clearDepth(this.descriptor.depthStencilAttachment.clearValue),e.clear(e.DEPTH_BUFFER_BIT),et.increment("api-calls",2))),this.descriptor.depthStencilAttachment?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),et.increment("api-calls",3)}}}class ie{constructor(e){this.pipeline=e}execute(){(qe()?G().getId():U().getId()).useProgram(this.pipeline.getDescriptor().shader.getId()),et.increment("api-calls",1)}}class se{constructor(e){this.indexBuffer=e}execute(){const e=qe()?G().getId():U().getId();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer.getId()),et.increment("api-calls",1)}}class ne{constructor(e,t){this.descriptor=e,this.shader=t}execute(){const e=qe()?G().getId():U().getId(),t=this.shader.getUniformLocation(this.descriptor.name);this.setUniform(e,t)}}class re extends ne{setUniform(e,t){e.uniform1f(t,this.descriptor.value),et.increment("api-calls",1)}}class ae extends ne{setUniform(e,t){e.uniform2fv(t,this.descriptor.value),et.increment("api-calls",1)}}class oe extends ne{setUniform(e,t){e.uniform3fv(t,this.descriptor.value),et.increment("api-calls",1)}}class ce extends ne{setUniform(e,t){e.uniform4fv(t,this.descriptor.value),et.increment("api-calls",1)}}class le extends ne{setUniform(e,t){e.uniformMatrix2fv(t,!1,this.descriptor.value),et.increment("api-calls",1)}}class he extends ne{setUniform(e,t){e.uniformMatrix3fv(t,!1,this.descriptor.value),et.increment("api-calls",1)}}class ue extends ne{setUniform(e,t){e.uniformMatrix4fv(t,!1,this.descriptor.value),et.increment("api-calls",1)}}class de extends ne{constructor(e,t){super(e,t),this.textureUnit=e.index}setUniform(e,t){e.activeTexture(e.TEXTURE0+this.textureUnit);const i=this.descriptor.value;e.bindTexture(e.TEXTURE_2D,i.getId()),e.uniform1i(t,this.textureUnit),et.increment("api-calls",3)}}class me{constructor(e){this.indexCount=e}execute(){const e=qe()?G().getId():U().getId();e.drawElements(e.TRIANGLES,this.indexCount,e.UNSIGNED_SHORT,0),et.increment("draw-calls",1),et.increment("api-calls",1),et.increment("rendered-instances",1)}}class pe{constructor(e){this.commands=[],this.query=e.query,this.commands.push(new te(e))}setPipelineCommand(e){this.pipeline=e,this.commands.push(new ie(e))}setIndexBufferCommand(e){this.commands.push(new se(e))}setUniformFloatCommand(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new re(e,t))}setUniformVec2Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new ae(e,t))}setUniformVec3Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new oe(e,t))}setUniformVec4Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new ce(e,t))}setUniformMat2Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new le(e,t))}setUniformMat3Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new he(e,t))}setUniformMat4Command(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new ue(e,t))}setUniformTextureCommand(e){const t=this.pipeline.getDescriptor().shader;this.commands.push(new de(e,t))}drawIndexedCommand(e){this.commands.push(new me(e))}pushDebugGroupCommand(){throw new Error("Debug groups are not supported in WebGL")}popDebugGroupCommand(){throw new Error("Debug groups are not supported in WebGL")}addDebugLabelCommand(){throw new Error("Debug labels are not supported in WebGL")}execute(){ot.getCapabilities().gpuTimer&&this.query?.begin();for(const e of this.commands)e.execute();ot.getCapabilities().gpuTimer&&(this.query?.end(),this.query?.update())}}class ge{constructor(e){this.descriptor=e}getId(){return null}getDescriptor(){return this.descriptor}}class fe{constructor(e){this.descriptor=e}async initialize(){this.pipeline=await L().getDevice().createRenderPipelineAsync({vertex:{module:this.descriptor.shader.getId(),buffers:this.descriptor.vertexBuffers.map((e=>({arrayStride:e.stride,stepMode:e.isInstanced?"instance":"vertex",attributes:e.attributes.map((e=>({shaderLocation:e.index,offset:e.offset,format:this.getFormat(e.format)})))})))},fragment:{module:this.descriptor.shader.getId(),targets:this.descriptor.attachmentFormats.map((e=>({format:"canvas"===e?L().getCanvasFormat():"rgba8unorm"})))},depthStencil:this.descriptor.depthAttachment?{format:"depth32float",depthWriteEnabled:!0,depthCompare:"less"}:void 0,primitive:{cullMode:"back"},layout:"auto",label:this.descriptor.label}),et.increment("api-calls",1)}getId(){return this.pipeline}getDescriptor(){return this.descriptor}getFormat(e){switch(e){case _.FLOAT_1:return"float32";case _.FLOAT_2:return"float32x2";case _.FLOAT_3:return"float32x3";case _.FLOAT_4:return"float32x4"}}}async function xe(e){if(We())return new ge(e);if(qe())return new ge(e);{const t=new fe(e);return t.initialize().then((()=>t))}}!function(e){e[e.FLOAT_1=1]="FLOAT_1",e[e.FLOAT_2=2]="FLOAT_2",e[e.FLOAT_3=3]="FLOAT_3",e[e.FLOAT_4=4]="FLOAT_4"}(_||(_={}));class ve{constructor(e,t){this.descriptor=e,this.pipeline=t}execute(){const e=this.descriptor.vertexBuffer,t=U().getId();t.bindBuffer(t.ARRAY_BUFFER,e.getId()),et.increment("api-calls",1);const i=this.pipeline.getDescriptor().vertexBuffers[this.descriptor.index];for(const e of i.attributes)t.vertexAttribPointer(e.index,this.getSize(e.format),t.FLOAT,!1,i.stride,e.offset+(this.descriptor.offset??0)),i.isInstanced?U().getInstancedRenderingExtension().vertexAttribDivisorANGLE(e.index,1):U().getInstancedRenderingExtension().vertexAttribDivisorANGLE(e.index,0),t.enableVertexAttribArray(e.index),et.increment("api-calls",3)}getSize(e){switch(e){case _.FLOAT_1:return 1;case _.FLOAT_2:return 2;case _.FLOAT_3:return 3;case _.FLOAT_4:return 4}}}class Ee{constructor(e){this.descriptor=e}execute(){const e=U().getId();U().getInstancedRenderingExtension().drawElementsInstancedANGLE(e.TRIANGLES,this.descriptor.indexCount,e.UNSIGNED_SHORT,0,this.descriptor.instanceCount),et.increment("draw-calls",1),et.increment("api-calls",1),et.increment("rendered-instances",this.descriptor.instanceCount)}}class be extends pe{setVertexBufferCommand(e){this.commands.push(new ve(e,this.pipeline))}setUniformBufferCommand(){throw new Error("Uniform buffers are not supported in WebGL 1")}drawInstancedIndexedCommand(e){this.commands.push(new Ee(e))}}class Ce{constructor(e,t){this.descriptor=e,this.pipeline=t}execute(){const e=this.descriptor.vertexBuffer,t=G().getId();t.bindBuffer(t.ARRAY_BUFFER,e.getId()),et.increment("api-calls",1);const i=this.pipeline.getDescriptor().vertexBuffers[this.descriptor.index];for(const e of i.attributes)t.vertexAttribPointer(e.index,this.getSize(e.format),t.FLOAT,!1,i.stride,e.offset+(this.descriptor.offset??0)),i.isInstanced?t.vertexAttribDivisor(e.index,1):t.vertexAttribDivisor(e.index,0),t.enableVertexAttribArray(e.index),et.increment("api-calls",3)}getSize(e){switch(e){case _.FLOAT_1:return 1;case _.FLOAT_2:return 2;case _.FLOAT_3:return 3;case _.FLOAT_4:return 4}}}class Te{constructor(e,t){this.descriptor=e,this.shader=t}execute(){const e=G().getId(),t=this.descriptor.value,i=this.shader,s=i.getUniformBlockIndex(this.descriptor.name);e.uniformBlockBinding(i.getId(),s,this.descriptor.index),e.bindBufferBase(e.UNIFORM_BUFFER,this.descriptor.index,t.getId()),et.increment("api-calls",2)}}class we{constructor(e){this.descriptor=e}execute(){const e=G().getId();e.drawElementsInstanced(e.TRIANGLES,this.descriptor.indexCount,e.UNSIGNED_SHORT,0,this.descriptor.instanceCount),et.increment("draw-calls",1),et.increment("rendered-instances",this.descriptor.instanceCount)}}class Ie extends pe{setVertexBufferCommand(e){this.commands.push(new Ce(e,this.pipeline))}setUniformBufferCommand(e){this.commands.push(new Te(e,this.pipeline.getDescriptor().shader))}drawInstancedIndexedCommand(e){this.commands.push(new we(e))}}class ye{constructor(){this.renderpasses=[]}createRenderpass(e){const t=this.createGlRenderpass(e);return this.renderpasses.push(t),t}createGlRenderpass(e){return We()?new be(e):new Ie(e)}execute(){for(const e of this.renderpasses)e.execute()}}class De{static get(e){const t=De.shaders.get(e);if(!t)throw new Error(`Couldn't find shader ${e}`);return t}}De.shaders=new Map,De.shaders.set("gl-vertex-lambertian","#if __VERSION__ == 100\r\n attribute vec3 vertexPosition; attribute vec3 vertexNormal; attribute mat4 M; attribute vec3 color; varying vec3 vf_normal; varying vec3 vf_color; uniform mat4 VP;\r\n#else\r\n layout(location = 0) in vec3 vertexPosition; layout(location = 1) in vec3 vertexNormal; layout(location = 3) in mat4 M; layout(location = 7) in vec3 color; out vec3 vf_normal; out vec3 vf_color; layout(std140) uniform FrameData { mat4 VP; vec3 light; };\r\n#endif\r\nvoid main() { vf_normal = vertexNormal; vf_color = color; gl_Position = VP * M * vec4(vertexPosition, 1.0);}"),De.shaders.set("gl-fragment-lambertian","precision highp float;\r\n#if __VERSION__ == 100\r\n varying vec3 vf_normal; varying vec3 vf_color; uniform vec3 light;\r\n#else\r\n in vec3 vf_normal; in vec3 vf_color; layout(location = 0) out vec4 color; layout(std140) uniform FrameData { mat4 VP; vec3 light; };\r\n#endif\r\nvoid main() { vec3 N = normalize(vf_normal); vec3 L = light; vec3 result = vf_color * dot(N, -L);\r\n #if __VERSION__ == 100\r\n gl_FragColor = vec4(result, 1.0);\r\n #else\r\n color = vec4(result, 1.0);\r\n #endif\r\n}"),De.shaders.set("gl-vertex-quad","#if __VERSION__ == 100\r\n attribute vec3 vertexPosition; attribute vec2 vertexTextureCoordinate; varying vec2 vf_vertexTextureCoordinate;\r\n#else\r\n layout(location = 0) in vec3 vertexPosition; layout(location = 2) in vec2 vertexTextureCoordinate; out vec2 vf_vertexTextureCoordinate;\r\n#endif\r\nvoid main() { vf_vertexTextureCoordinate = vertexTextureCoordinate; gl_Position = vec4(vertexPosition, 1.0);}"),De.shaders.set("gl-fragment-quad","precision highp float;\r\n#if __VERSION__ == 100\r\n varying vec2 vf_vertexTextureCoordinate;\r\n#else\r\n in vec2 vf_vertexTextureCoordinate; layout(location = 0) out vec4 color;\r\n#endif\r\nuniform sampler2D image;void main() {\r\n #if __VERSION__ == 100\r\n gl_FragColor = texture2D(image, vf_vertexTextureCoordinate);\r\n #else\r\n color = texture(image, vf_vertexTextureCoordinate);\r\n #endif\r\n}"),De.shaders.set("gpu-lambertian","struct FrameData{VP:mat4x4f,light:vec3f};@group(0)@binding(0)var<uniform>frameData:FrameData;struct Vertex{@location(0)vertexPosition:vec3f,@location(1)vertexNormal:vec3f,@location(3)M1:vec4f,@location(4)M2:vec4f,@location(5)M3:vec4f,@location(6)M4:vec4f,@location(7)color:vec3f};struct Varying{@builtin(position)position:vec4f,@location(0)normal:vec3f,@location(1)color:vec3f};@vertex fn vertex(vertex:Vertex)->Varying{var vf_varying:Varying;let M=mat4x4f(vertex.M1,vertex.M2,vertex.M3,vertex.M4);vf_varying.position=frameData.VP*M*vec4f(vertex.vertexPosition,1.0);vf_varying.normal=vertex.vertexNormal;vf_varying.color=vertex.color;return vf_varying;}@fragment fn fragment(vf_varying:Varying)->@location(0)vec4f{let N=normalize(vf_varying.normal);let L=frameData.light;return vec4f(vf_varying.color*dot(N,-L),1.0);}"),De.shaders.set("gpu-quad","struct Vertex{@location(0)vertexPosition:vec3f,@location(2)vertexTextureCoordinate:vec2f,};struct Varying{@builtin(position)position:vec4f,@location(0)textureCoordinate:vec2f};@vertex fn vertex(vertex:Vertex)->Varying{var vf_varying:Varying;vf_varying.position=vec4f(vertex.vertexPosition,1.0);vf_varying.textureCoordinate=vertex.vertexTextureCoordinate;return vf_varying;}@group(0)@binding(0)var quadSampler:sampler;@group(0)@binding(1)var quadTexture:texture_2d<f32>;@fragment fn fragment(vf_varying:Varying)->@location(0)vec4f{return textureSample(quadTexture,quadSampler,vf_varying.textureCoordinate);}");class Se{constructor(e){this.uniformLocations=new Map,this.context=qe()?G().getId():U().getId();const t=this.getShader(this.context.VERTEX_SHADER,De.get(`gl-vertex-${e.name}`)),i=this.getShader(this.context.FRAGMENT_SHADER,De.get(`gl-fragment-${e.name}`));this.program=this.context.createProgram(),this.setAttributeLocations(),this.context.attachShader(this.program,t),this.context.attachShader(this.program,i),this.context.linkProgram(this.program),this.context.deleteShader(t),this.context.deleteShader(i),et.increment("api-calls",6)}getId(){return this.program}getShader(e,t){const i=this.getShaderHeader()+t,s=this.context.createShader(e);return this.context.shaderSource(s,i),this.context.compileShader(s),et.increment("api-calls",3),s}getUniformLocation(e){let t=this.uniformLocations.get(e);return t||(t=this.context.getUniformLocation(this.program,e)??void 0,et.increment("api-calls",1),this.uniformLocations.set(e,t)),t}release(){this.context.deleteProgram(this.program),et.increment("api-calls",1)}}class _e extends Se{getShaderHeader(){return""}setAttributeLocations(){const e=U().getId();e.bindAttribLocation(this.program,0,"vertexPosition"),e.bindAttribLocation(this.program,1,"vertexNormal"),e.bindAttribLocation(this.program,2,"vertexTextureCoordinate"),e.bindAttribLocation(this.program,3,"M"),e.bindAttribLocation(this.program,7,"color"),et.increment("api-calls",5)}}class Ae extends Se{constructor(){super(...arguments),this.uniformBlockIndices=new Map}getShaderHeader(){return"#version 300 es\n"}setAttributeLocations(){}getUniformBlockIndex(e){const t=G().getId();let i=this.uniformBlockIndices.get(e);return null==i&&(i=t.getUniformBlockIndex(this.program,e),et.increment("api-calls",1),this.uniformBlockIndices.set(e,i)),i}}class Be{constructor(e){this.shaderModule=L().getDevice().createShaderModule({code:De.get(`gpu-${e.name}`),label:e.label}),et.increment("api-calls",1)}getId(){return this.shaderModule}async logCompilationInfo(){}getShaderModule(){return this.shaderModule}release(){}}function Fe(e){return We()?new _e(e):qe()?new Ae(e):new Be(e)}class Me{constructor(e){this.inProgress=!1,this.handler=e.handler}update(){if(this.inProgress&&this.isResultAvailable()){if(this.isResultValid()){const e=this.getResult();this.handler(T(e))}this.inProgress=!1}}}class Re extends Me{constructor(e){super(e),this.gpuTimeExtension=U().getGpuTimeExtension(),this.query=this.gpuTimeExtension.createQueryEXT(),et.increment("api-calls",1)}getId(){return this.query}begin(){this.inProgress||(this.gpuTimeExtension.beginQueryEXT(this.gpuTimeExtension.TIME_ELAPSED_EXT,this.query),et.increment("api-calls",1))}end(){this.inProgress||(this.gpuTimeExtension.endQueryEXT(this.gpuTimeExtension.TIME_ELAPSED_EXT),U().getId().flush(),et.increment("api-calls",2),this.inProgress=!0)}isResultAvailable(){return et.increment("api-calls",1),this.gpuTimeExtension.getQueryObjectEXT(this.query,this.gpuTimeExtension.QUERY_RESULT_AVAILABLE_EXT)}isResultValid(){return et.increment("api-calls",1),!U().getId().getParameter(this.gpuTimeExtension.GPU_DISJOINT_EXT)}getResult(){return et.increment("api-calls",1),this.gpuTimeExtension.getQueryObjectEXT(this.query,this.gpuTimeExtension.QUERY_RESULT_EXT)}release(){this.gpuTimeExtension.deleteQueryEXT(this.query),et.increment("api-calls",1)}}class Pe extends Me{constructor(e){super(e),this.context=G().getId(),this.query=this.context.createQuery(),et.increment("api-calls",1)}getId(){return this.query}begin(){this.inProgress||(this.context.beginQuery(G().getGpuTimeExtension().TIME_ELAPSED_EXT,this.query),et.increment("api-calls",1))}end(){this.inProgress||(this.context.endQuery(G().getGpuTimeExtension().TIME_ELAPSED_EXT),this.context.flush(),et.increment("api-calls",2),this.inProgress=!0)}isResultAvailable(){return et.increment("api-calls",1),this.context.getQueryParameter(this.query,this.context.QUERY_RESULT_AVAILABLE)}isResultValid(){return et.increment("api-calls",1),!this.context.getParameter(G().getGpuTimeExtension().GPU_DISJOINT_EXT)}getResult(){return et.increment("api-calls",1),this.context.getQueryParameter(this.query,this.context.QUERY_RESULT)}release(){this.context.deleteQuery(this.query),et.increment("api-calls",1)}}class Ue{constructor(e){this.querySet=L().getDevice().createQuerySet({label:e.label,count:2,type:"timestamp"}),this.resolveQueryBufer=L().getDevice().createBuffer({label:"resolve query buffer",size:8*Ue.TIMESTAMP_COUNT,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultQueryBuffer=L().getDevice().createBuffer({label:"result query buffer",size:8*Ue.TIMESTAMP_COUNT,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),et.increment("api-calls",3),et.increment("buffer-data",16*Ue.TIMESTAMP_COUNT),this.handler=e.handler}getId(){return this.querySet}resolve(e){e.resolveQuerySet(this.querySet,0,2,this.resolveQueryBufer,0),et.increment("api-calls",1),"unmapped"===this.resultQueryBuffer.mapState&&(e.copyBufferToBuffer(this.resolveQueryBufer,0,this.resultQueryBuffer,0,this.resultQueryBuffer.size),et.increment("api-calls",1))}update(){"unmapped"===this.resultQueryBuffer.mapState&&(this.resultQueryBuffer.mapAsync(GPUMapMode.READ).then((()=>{const e=new BigInt64Array(this.resultQueryBuffer.getMappedRange()),t=T(Number(e[0])),i=T(Number(e[1]));this.handler(i-t),this.resultQueryBuffer.unmap(),et.increment("api-calls",2)})),et.increment("api-calls",1))}release(){this.querySet.destroy(),this.resolveQueryBufer.destroy(),this.resultQueryBuffer.destroy(),et.increment("buffer-data",-16*Ue.TIMESTAMP_COUNT),et.increment("api-calls",3)}}Ue.TIMESTAMP_COUNT=2;class Ge{static updateMaxCellDistance(){const e=Ze.getCellSize()/2,t=e*e;Ge.maxCellDistance=Math.sqrt(t+t)}static getMaxCellDistance(){return Ge.maxCellDistance}constructor(e,t,i,s){this.x=0,this.z=0,this.scene=new Map,this.entityCount=0,this.valid=!1,this.instanceCount=0,this.vertexCount=0,this.triangleCount=0,this.cornerPoints=[],this.aabbMin=n(),this.aabbMax=n(),this.initialize(e,t,i,s)}initialize(e,t,i,s){this.x=i,this.z=s,this.entityCount=e.length,this.scene.clear();for(const i of t)this.scene.set(i,e.filter((e=>e.mesh===i.name)));this.instanceBuffer=this.createInstanceBuffer(),this.valid=!0,this.instanceCount=e.length,et.increment("instances",e.length),this.vertexCount=0,this.triangleCount=0;for(const[e,t]of this.scene)this.vertexCount+=e.vertexCount*t.length,this.triangleCount+=e.indexCount/3*t.length;if(Ge.updateMaxCellDistance(),!this.cornerPoints.length)for(let e=0;e<8;e++)this.cornerPoints.push(d());et.increment("vertices",this.vertexCount),et.increment("triangles",this.triangleCount)}getX(){return this.x}getZ(){return this.z}isValid(){return this.valid}createInstanceBuffer(){return W({type:"data-callback",size:19*this.entityCount*4,callback:e=>{const t=new Float32Array(e);let i=0;for(const e of this.scene.values())this.addInstanceData(t,e,i),i+=e.length},usage:S.VERTEX})}addInstanceData(e,t,i){for(let s=0;s<t.length;s++){const n=t[s],r=19*(s+i);u(Ge.M,g(Ge.q,n.rotation[0],n.rotation[1],n.rotation[2]),n.position,n.scale),e.set(Ge.M,r),e.set(n.color,r+16)}}render(e,t,i){if(Ze.isFrustumCulling()&&!this.isInFrustum())return;et.increment("rendered-cells",1);let s=0;const n=ot.getCapabilities().instanceOffset;n&&e.setVertexBufferCommand({vertexBuffer:this.instanceBuffer,index:1});for(const[r,a]of this.scene){if(!a.length)continue;e.setVertexBufferCommand({vertexBuffer:t[r.vertexBufferIndex],index:0}),n||e.setVertexBufferCommand({vertexBuffer:this.instanceBuffer,index:1,offset:19*s*4}),e.setIndexBufferCommand(i[r.indexBufferIndex]);const o=n?s:0;e.drawInstancedIndexedCommand({indexCount:r.indexCount,instanceCount:a.length,instanceOffset:o}),et.increment("rendered-vertices",r.vertexCount*a.length),et.increment("rendered-triangles",r.indexCount/3*a.length),s+=a.length}}isInFrustum(){return this.computeCornerPointsInNdc(),this.computeAabbMin(),this.computeAabbMax(),this.aabbMin[0]<=1&&this.aabbMin[1]<=1&&this.aabbMin[2]<=1&&this.aabbMax[0]>=-1&&this.aabbMax[1]>=-1&&this.aabbMax[2]>=-1}computeCornerPointsInNdc(){const e=Ze.getCellSize()/2;this.worldSpaceToNdc(m(this.cornerPoints[0],this.x-e,0,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[1],this.x-e,e,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[2],this.x+e,e,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[3],this.x+e,0,this.z+e,1)),this.worldSpaceToNdc(m(this.cornerPoints[4],this.x-e,0,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[5],this.x-e,e,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[6],this.x+e,e,this.z-e,1)),this.worldSpaceToNdc(m(this.cornerPoints[7],this.x+e,0,this.z-e,1))}computeAabbMin(){a(this.aabbMin,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(const e of this.cornerPoints)this.aabbMin[0]=Math.min(this.aabbMin[0],e[0]),this.aabbMin[1]=Math.min(this.aabbMin[1],e[1]),this.aabbMin[2]=Math.min(this.aabbMin[2],e[2])}computeAabbMax(){a(this.aabbMax,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const e of this.cornerPoints)this.aabbMax[0]=Math.max(this.aabbMax[0],e[0]),this.aabbMax[1]=Math.max(this.aabbMax[1],e[1]),this.aabbMax[2]=Math.max(this.aabbMax[2],e[2])}worldSpaceToNdc(e){return function(e,t,i){var s=t[0],n=t[1],r=t[2],a=t[3];e[0]=i[0]*s+i[4]*n+i[8]*r+i[12]*a,e[1]=i[1]*s+i[5]*n+i[9]*r+i[13]*a,e[2]=i[2]*s+i[6]*n+i[10]*r+i[14]*a,e[3]=i[3]*s+i[7]*n+i[11]*r+i[15]*a}(e,e,rt.getVP()),function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}(e,e,1/Math.abs(e[3]))}reset(){this.instanceBuffer.release(),this.instanceBuffer=this.createInstanceBuffer(),Ge.updateMaxCellDistance()}release(){this.instanceBuffer.release(),et.increment("instances",-this.instanceCount),et.increment("vertices",-this.vertexCount),et.increment("triangles",-this.triangleCount);for(const e of this.scene.values()){e.length&&I(e[0].color);for(const t of e)I(t.position),I(t.scale)}this.scene.clear(),this.valid=!1}}Ge.M=h(),Ge.q=p(),Ge.maxCellDistance=0;class Le{constructor(e){this.context=qe()?G().getId():U().getId(),this.id=this.context.createTexture(),this.context.bindTexture(this.context.TEXTURE_2D,this.id),this.context.texImage2D(this.context.TEXTURE_2D,0,this.getInternalFormat(e),e.width,e.height,0,this.getFormat(e),this.getType(e),e.data??null),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),et.increment("api-calls",7)}getId(){return this.id}getFormat(e){switch(e.format){case"rgba8":return this.context.RGBA;case"depth":return this.context.DEPTH_COMPONENT}}release(){this.context.deleteTexture(this.id),et.increment("api-calls",1)}}class Ne extends Le{getInternalFormat(e){switch(e.format){case"rgba8":return this.context.RGBA;case"depth":return this.context.DEPTH_COMPONENT}}getType(e){switch(e.format){case"rgba8":return this.context.UNSIGNED_BYTE;case"depth":return this.context.UNSIGNED_INT}}}class Oe extends Le{constructor(e){super(e),this.context=G().getId()}getInternalFormat(e){switch(e.format){case"rgba8":return this.context.RGBA8;case"depth":return this.context.DEPTH_COMPONENT32F}}getType(e){switch(e.format){case"rgba8":return this.context.UNSIGNED_BYTE;case"depth":return this.context.FLOAT}}}class ze{constructor(e){this.id=L().getDevice().createTexture({dimension:"2d",format:this.getFormat(e),usage:this.getUsage(e),size:{width:e.width,height:e.height},label:e.label}),this.sampler=L().getDevice().createSampler({label:e.label,minFilter:"nearest",magFilter:"nearest",mipmapFilter:"nearest",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge"}),et.increment("api-calls",2)}getUsage(e){let t=0;return e.rendered&&(t|=GPUTextureUsage.RENDER_ATTACHMENT),e.sampled&&(t|=GPUTextureUsage.TEXTURE_BINDING),t}getId(){return this.id}getSampler(){return this.sampler}getBindGroup(e,t){return this.bindGroup||(this.bindGroup=L().getDevice().createBindGroup({layout:e.getBindGroupLayout(t),entries:[{binding:0,resource:this.sampler},{binding:1,resource:this.getView()}]}),et.increment("api-calls",1)),this.bindGroup}getFormat(e){switch(e.format){case"rgba8":return"rgba8unorm";case"depth":return"depth32float"}}getView(){return this.view||(this.view=this.id.createView(),et.increment("api-calls",1)),this.view}release(){this.id.destroy(),et.increment("api-calls",1)}}function Ve(e){return We()?new Ne(e):qe()?new Oe(e):new ze(e)}function We(){return ot.getRenderingApi()===A.WEBGL_1}function qe(){return ot.getRenderingApi()===A.WEBGL_2}!function(e){e[e.WEBGL_1=1]="WEBGL_1",e[e.WEBGL_2=2]="WEBGL_2",e[e.WEBGPU=3]="WEBGPU"}(A||(A={}));class Xe{constructor(){this.restarted=!1,this.vertexBuffers=[],this.indexBuffers=[],this.meshes=[],this.lightDirection=n(),this.cells=[],this.cellsPool=[],this.capabilities={gpuTimer:!1,uniformBuffer:!1,instancedRendering:!1,isNdcCube:!0,debugGroups:!1,instanceOffset:!1,depthTexture:!1,uvUp:!0}}getRenderingApi(){return this.renderingApi}getCapabilities(){return this.capabilities}getCanvas(){return this.canvas}getContext(){return this.context}async initialize(e){this.createCell=e,await this.initializeWithApi()}getApiList(){switch(Ze.getRenderingApi()){case D.WEBGPU:return[A.WEBGPU];case D.WEBGL_2:return[A.WEBGL_2];case D.WEBGL_1:return[A.WEBGL_1];default:return[A.WEBGPU,A.WEBGL_2,A.WEBGL_1]}}async initializeWithApi(e=this.getApiList()){this.canvas=this.getCanvasElement();for(const t of e)try{this.renderingApi=t,await this.createResources();for(const e of this.cells)e.reset();return}catch(e){continue}throw new Error("No rendering API is available")}async createResources(){if(this.context=await async function(){if(We()){const e=new M;return e.initialize(),e}if(qe()){const e=new R;return e.initialize(),e}{const e=new P;return await e.initialize(),e}}(),!this.capabilities.instancedRendering)throw new Error("Instanced rendering is not supported");if(!this.capabilities.depthTexture)throw new Error("Depth textures are not supported");const e=this.createLambertianPipeline(),t=this.createQuadPipeline();this.createQuery(),this.createMeshes(),this.createUniformBuffer(),this.recreateRenderpassAttachments(),this.lambertianPipeline=await e,this.quadPipeline=await t}getCanvasElement(){const e=document.querySelector("canvas");if(!e)throw new Error("Couldn't find the canvas element");return e}addMesh(e,t,i,s,n){this.vertexBuffers.push(t),this.indexBuffers.push(i),this.meshes.push({name:e,vertexBufferIndex:this.vertexBuffers.length-1,indexBufferIndex:this.indexBuffers.length-1,vertexCount:s,indexCount:n})}async createLambertianPipeline(){return xe({label:"lambertian pipeline",shader:Fe({name:"lambertian",label:"lambertian shader"}),vertexBuffers:[{stride:32,isInstanced:!1,attributes:[{index:0,offset:0,format:_.FLOAT_3},{index:1,offset:12,format:_.FLOAT_3}]},{stride:76,isInstanced:!0,attributes:[{index:3,offset:0,format:_.FLOAT_4},{index:4,offset:16,format:_.FLOAT_4},{index:5,offset:32,format:_.FLOAT_4},{index:6,offset:48,format:_.FLOAT_4},{index:7,offset:64,format:_.FLOAT_3}]}],attachmentFormats:["rgba8"],depthAttachment:!0})}async createQuadPipeline(){return xe({label:"quad pipeline",shader:Fe({name:"quad",label:"quad shader"}),vertexBuffers:[{stride:32,isInstanced:!1,attributes:[{index:0,offset:0,format:_.FLOAT_3},{index:2,offset:24,format:_.FLOAT_2}]}],attachmentFormats:["canvas"]})}createQuery(){var e;this.capabilities.gpuTimer&&(this.query=(e={label:"gpu timer query",handler:e=>{Je.addElapsedGpuTime(e)}},We()?new Re(e):qe()?new Pe(e):new Ue(e)))}createMeshes(){!function(){const e=ot.getCapabilities().uvUp,t=e?1:0,i=e?0:1,s=W({type:"data-callback",callback:e=>{new Float32Array(e).set([-1,1,0,0,0,1,0,t,-1,-1,0,0,0,1,0,i,1,-1,0,0,0,1,1,i,1,1,0,0,0,1,1,t])},size:128,usage:S.VERTEX,label:"Quad vertex buffer"}),n=W({type:"data-callback",callback:e=>{new Uint16Array(e).set([0,1,2,3,0,2])},size:12,usage:S.INDEX,label:"Quad index buffer"});ot.addMesh("quad",s,n,4,6)}(),function(){const e=W({type:"data-callback",callback:e=>{new Float32Array(e).set([-.5,.5,.5,0,0,1,0,0,-.5,-.5,.5,0,0,1,0,0,.5,-.5,.5,0,0,1,0,0,.5,.5,.5,0,0,1,0,0,-.5,.5,-.5,-1,0,0,0,0,-.5,-.5,-.5,-1,0,0,0,0,-.5,-.5,.5,-1,0,0,0,0,-.5,.5,.5,-1,0,0,0,0,.5,.5,.5,1,0,0,0,0,.5,-.5,.5,1,0,0,0,0,.5,-.5,-.5,1,0,0,0,0,.5,.5,-.5,1,0,0,0,0,.5,.5,-.5,0,0,-1,0,0,.5,-.5,-.5,0,0,-1,0,0,-.5,-.5,-.5,0,0,-1,0,0,-.5,.5,-.5,0,0,-1,0,0,-.5,.5,-.5,0,1,0,0,0,-.5,.5,.5,0,1,0,0,0,.5,.5,.5,0,1,0,0,0,.5,.5,-.5,0,1,0,0,0,-.5,-.5,.5,0,-1,0,0,0,-.5,-.5,-.5,0,-1,0,0,0,.5,-.5,-.5,0,-1,0,0,0,.5,-.5,.5,0,-1,0,0,0])},size:768,usage:S.VERTEX,label:"Cube vertex buffer"}),t=W({type:"data-callback",callback:e=>{new Uint16Array(e).set([0,1,2,3,0,2,4,5,6,7,4,6,8,9,10,11,8,10,12,13,14,15,12,14,16,17,18,19,16,18,20,21,22,23,20,22])},size:72,usage:S.INDEX,label:"Cube index buffer"});ot.addMesh("cube",e,t,24,36)}(),et.set("meshes",this.meshes.length)}createUniformBuffer(){if(this.capabilities.uniformBuffer){const e=4;this.uniformBuffer=W({type:"size",size:76+e,usage:S.UNIFORM,dynamic:!0})}this.uniformBufferData=new Float32Array(20)}async render(){this.clearPerFrameStatistics(),this.restarted&&await this.handleRestart(),this.handleResize();const e=("default command buffer",We()||qe()?new ye:new ee("default command buffer"));this.renderScene(e),this.renderToCanvas(e),e.execute()}renderScene(e){const t=e.createRenderpass({type:"offscreen",colorAttachments:[{texture:this.color,clearColor:[.7,.8,1,1]}],depthStencilAttachment:{texture:this.depth,clearValue:1},label:"lambertian renderpass",query:this.query});t.setPipelineCommand(this.lambertianPipeline),this.updateCells(t),this.updateUniforms(t),this.renderCells(t)}renderToCanvas(e){const t=e.createRenderpass({type:"canvas",label:"canvas renderpass"}),i=this.meshes.find((e=>"quad"===e.name));if(!i)throw new Error("Couldn't find quad mesh");t.setPipelineCommand(this.quadPipeline),t.setVertexBufferCommand({vertexBuffer:this.vertexBuffers[i.vertexBufferIndex],index:0}),t.setIndexBufferCommand(this.indexBuffers[i.indexBufferIndex]),t.setUniformTextureCommand({name:"image",value:this.color,index:0}),t.drawIndexedCommand(i.indexCount)}async handleRestart(){await this.release();const e=this.canvas.cloneNode(!1);this.canvas.replaceWith(e),this.canvas=e,await this.initializeWithApi(),this.restarted=!1}handleResize(){this.canvas.width===window.innerWidth&&this.canvas.height===window.innerHeight||(this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,st.update(),rt.invalidate(),this.recreateRenderpassAttachments())}recreateRenderpassAttachments(){this.color&&this.color.release(),this.depth&&this.depth.release(),this.color=Ve({type:"2d",format:"rgba8",width:this.canvas.clientWidth,height:this.canvas.clientHeight,rendered:!0,sampled:!0,label:"color buffer"}),this.depth=Ve({type:"2d",format:"depth",width:this.canvas.clientWidth,height:this.canvas.clientHeight,rendered:!0,label:"depth buffer"})}updateCells(e){this.removeCells(),this.addCells()}removeCells(){this.cells.filter((e=>!this.isCellInRange(e.getX(),e.getZ()))).forEach((e=>{e.release(),this.cellsPool.push(e)})),this.cells=this.cells.filter((e=>e.isValid()))}addCells(){const e=Ze.getCellSize(),t=rt.getPosition(),i=Math.round(t[0]/e)*e,s=Math.round(t[2]/e)*e,n=y.getMaxFrustumDistance(),r=Math.round(n/e)+2;let a=0;for(let t=-r;t<=r;t++)for(let n=-r;n<=r;n++){const r=i+n*e,o=s+t*e,c=this.isCellInRange(r,o);if(this.cells.every((e=>e.getX()!==r||e.getZ()!==o))&&c){const e=this.getCell(r,o);this.cells.push(e)}this.updateCellsDebugger(a,n,t,r,o,c),a++}}getCell(e,t){if(this.cellsPool.length){const i=this.cellsPool.pop();return i.initialize(this.createCell(e,t),this.meshes,e,t),i}return new Ge(this.createCell(e,t),this.meshes,e,t)}updateCellsDebugger(e,t,i,s,n,r){if(Ze.isCellsDebugger()){if(r){const t=this.cells.find((e=>e.getX()===s&&e.getZ()===n));t&&(Ze.isFrustumCulling()&&t.isInFrustum()?st.setCellState(e,"in-frustum"):st.setCellState(e,"in-range"))}else st.setCellState(e,"out-of-range");0===t&&0===i&&st.setCellState(e,"camera")}}renderCells(e){et.set("cells",this.cells.length);for(const t of this.cells)t.render(e,this.vertexBuffers,this.indexBuffers)}clearPerFrameStatistics(){et.set("api-calls",0),et.set("draw-calls",0),et.set("rendered-cells",0),et.set("rendered-instances",0),et.set("rendered-vertices",0),et.set("rendered-triangles",0)}updateUniforms(e){l(this.lightDirection,a(this.lightDirection,-1,-2,-3)),this.capabilities.uniformBuffer?(this.uniformBufferData.set(rt.getVP(),0),this.uniformBufferData.set(this.lightDirection,16),this.uniformBuffer.setData({type:"buffer",data:this.uniformBufferData}),e.setUniformBufferCommand({index:0,name:"FrameData",value:this.uniformBuffer})):(e.setUniformMat4Command({name:"VP",value:rt.getVP()}),e.setUniformVec3Command({name:"light",value:this.lightDirection}))}isCellInRange(e,t){const i=y.getMaxFrustumDistance(),s=Ge.getMaxCellDistance(),n=rt.getPosition(),r=e-n[0],a=t-n[2];return Math.sqrt(r*r+a*a)<=i+s}restart(){this.restarted=!0}removeAllCells(){for(const e of this.cells)e.release();this.cells.length=0}async release(){await this.context.stop(),this.capabilities.gpuTimer&&this.query?.release(),this.meshes.length=0;for(const e of this.vertexBuffers)e.release();this.vertexBuffers.length=0;for(const e of this.indexBuffers)e.release();this.indexBuffers.length=0,this.uniformBuffer?.release(),this.depth.release(),this.color.release(),this.quadPipeline.getDescriptor().shader.release(),this.lambertianPipeline.getDescriptor().shader.release(),this.context.release()}}class ke{constructor(){this.showingStatistics=!1,this.statisticsElement=C("#statistics"),this.renderingApiElement=C("#rendering-api"),this.fpsFrameTimeElement=C("#fps-frame-time"),this.cpuTimeElement=C("#cpu-time"),this.gpuTimeElement=C("#gpu-time"),this.apiCallsElement=C("#api-calls"),this.drawCallsElement=C("#draw-calls"),this.bufferDataElement=C("#buffer-data"),this.meshesElement=C("#meshes"),this.cellsElement=C("#cells"),this.renderedCellsElement=C("#rendered-cells"),this.instancesElement=C("#instances"),this.renderedInstancesElement=C("#rendered-instances"),this.verticesElement=C("#vertices"),this.renderedVerticesElement=C("#rendered-vertices"),this.trianglesElement=C("#triangles"),this.renderedTrianglesElement=C("#rendered-triangles")}update(){Ze.isStatistics()&&(this.showingStatistics||(this.statisticsElement.style.display="block",this.showingStatistics=!0),this.updateElements())}updateElements(){this.updateRenderingApi(),this.updateFpsFrameTime(),this.updateCpuTime(),this.updateGpuTime(),this.updateElement(this.apiCallsElement,"API calls","api-calls"),this.updateElement(this.drawCallsElement,"Draw calls","draw-calls"),this.updateBufferData(),this.updateElement(this.meshesElement,"Meshes","meshes"),this.updateElement(this.cellsElement,"Cells in range","cells"),this.updateElement(this.renderedCellsElement,"Rendered cells","rendered-cells"),this.updateElement(this.instancesElement,"Instances","instances"),this.updateElement(this.renderedInstancesElement,"Rendered instances","rendered-instances"),this.updateElement(this.verticesElement,"Vertices","vertices"),this.updateElement(this.renderedVerticesElement,"Rendered vertices","rendered-vertices"),this.updateElement(this.trianglesElement,"Triangles","triangles"),this.updateElement(this.renderedTrianglesElement,"Rendered triangles","rendered-triangles")}updateRenderingApi(){this.renderingApiElement.textContent=function(e){switch(e){case A.WEBGL_1:return"WebGL 1";case A.WEBGL_2:return"WebGL 2";case A.WEBGPU:return"WebGPU"}}(ot.getRenderingApi())}updateFpsFrameTime(){const e=Je.getFps(),t=(1/e*1e3).toFixed(2);this.fpsFrameTimeElement.textContent=`${e} FPS / ${t} ms`}updateCpuTime(){const e=Je.getJsTime().toFixed(2);this.cpuTimeElement.textContent=`CPU time: ${e} ms`}updateGpuTime(){if(ot.getCapabilities().gpuTimer){const e=Je.getGpuTime().toFixed(2);this.gpuTimeElement.textContent=`GPU time: ${e} ms`}else this.gpuTimeElement.textContent=""}updateBufferData(){const e=(et.getValue("buffer-data")/1024/1024).toFixed(2);this.bufferDataElement.textContent=`Memory in buffers: ${e} MB`}updateElement(e,t,i){e.textContent=`${t}: ${et.get(i)}`}hide(){this.statisticsElement.style.display="none",this.showingStatistics=!1}}class Qe{constructor(){this.dialog=C("dialog"),this.initializeOpenOptionsButton(),this.initializeCloseOptionsButton(),this.apiSelector=this.initializeApiSelector(),this.initializeFovY(),this.initializeViewDistance(),this.initializeCellSize(),this.initializeInstanceCount(),this.initializeStatistics(),this.initializeFrustumCulling(),this.initializeCellsDebugger()}initializeOpenOptionsButton(){C("#open-options-button").addEventListener("click",(()=>{this.dialog.showModal()}))}initializeCloseOptionsButton(){C("#close-options-button").addEventListener("click",(()=>{this.dialog.close()}))}initializeApiSelector(){const e=C("#rendering-api-selector");return e.value=Ze.getRenderingApi().toString(),e.addEventListener("change",(async()=>{Ze.setRenderingApi(+this.apiSelector.value)})),e}initializeFovY(){const e=C("#fovy-input");e.value=Ze.getFovY().toString(),e.addEventListener("change",(()=>{Ze.setFovY(+e.value)}))}initializeViewDistance(){const e=C("#view-distance-input");e.value=Ze.getViewDistance().toString(),e.addEventListener("change",(()=>{Ze.setViewDistance(+e.value)}))}initializeCellSize(){const e=C("#cell-size-input");e.value=Ze.getCellSize().toString(),e.addEventListener("change",(()=>{Ze.setCellSize(+e.value)}))}initializeInstanceCount(){const e=C("#instance-count-input");e.value=Ze.getInstanceCount().toString(),e.addEventListener("change",(()=>{Ze.setInstanceCount(+e.value)}))}initializeFrustumCulling(){const e=C("#frustum-culling-input");e.checked=Ze.isFrustumCulling(),e.addEventListener("change",(()=>{Ze.setFrustumCulling(e.checked)}))}initializeCellsDebugger(){const e=C("#cells-debugger-input");e.checked=Ze.isCellsDebugger(),Ze.isCellsDebugger()&&st.update(),e.addEventListener("change",(()=>{Ze.setCellsDebugger(e.checked)}))}initializeStatistics(){const e=C("#statistics-input");e.checked=Ze.isStatistics(),e.addEventListener("change",(()=>{Ze.setStatistics(e.checked)}))}getSelectedRenderingApi(){return Number.parseInt(this.apiSelector.value)}isDialogOpened(){return this.dialog.open}}class Ye{constructor(){this.cellElements=[],this.grid=C("#cells-debugger")}update(){for(;this.grid.lastChild;)this.grid.removeChild(this.grid.lastChild);if(this.cellElements.length=0,!Ze.isCellsDebugger())return;const e=y.getMaxFrustumDistance(),t=2*(Math.round(e/Ze.getCellSize())+2)+1;this.grid.style.gridTemplateColumns=`repeat(${t}, 1fr)`,this.grid.style.gridTemplateRows=`repeat(${t}, 1fr)`,this.updateCells(t)}updateCells(e){const t=ot.getCanvas().clientHeight/3/e;for(let i=0;i<e*e;i++){const e=document.createElement("div");e.style.width=`${t}px`,e.style.height=`${t}px`,this.grid.appendChild(e),this.cellElements.push(e)}}show(){this.grid.style.display="grid"}hide(){this.grid.style.display="none"}setCellState(e,t){this.cellElements[e].className=this.getClass(t)}getClass(e){switch(e){case"camera":return"camera-cell";case"in-frustum":return"in-frustum-cell";case"in-range":return"in-range-cell";case"out-of-range":return"out-of-range-cell"}}}class He{constructor(){this.statistics=new Map}get(e){const t=this.statistics.get(e);return void 0===t?"-":t.toLocaleString()}getValue(e){return this.statistics.get(e)??0}set(e,t){this.statistics.set(e,t)}increment(e,t){const i=(this.statistics.get(e)??0)+t;this.set(e,i)}}class $e{constructor(){this.startMoment=performance.now(),this.lastFrameEndMoment=this.startMoment,this.frameStartMoment=0,this.averageFps=0,this.frameCount=0,this.currentSecondFrameCount=0,this.lastFrameTime=0,this.frameTimeSum=0,this.averageJsTime=0,this.jsTimeSum=0,this.averageGpuTime=0,this.gpuTimeSum=0,this.gpuTimeCount=0,this.gpuSecondStartMoment=this.startMoment}addElapsedGpuTime(e){const t=performance.now();this.gpuTimeSum+=e,this.gpuTimeCount++,this.gpuSecondStartMoment+$e.ONE_SECOND<t&&(this.averageGpuTime=this.gpuTimeSum/this.gpuTimeCount,this.gpuTimeSum=0,this.gpuTimeCount=0,this.gpuSecondStartMoment=t)}startFrame(){this.frameStartMoment=performance.now()}endFrame(){const e=performance.now();this.jsTimeSum+=e-this.frameStartMoment,this.lastFrameTime=e-this.lastFrameEndMoment,this.frameTimeSum+=this.lastFrameTime,this.lastFrameEndMoment=e,this.frameCount++,this.currentSecondFrameCount++,this.frameTimeSum>=$e.ONE_SECOND&&(this.averageFps=Math.round(this.currentSecondFrameCount/this.frameTimeSum*$e.ONE_SECOND),this.averageJsTime=this.jsTimeSum/this.currentSecondFrameCount,this.jsTimeSum=0,this.frameTimeSum=0,this.currentSecondFrameCount=0,tt.update())}getDeltaTimeFactor(){return this.lastFrameTime}getFps(){return this.averageFps}getTimeInMillisecs(){return performance.now()-this.startMoment}getTimeInSecs(){return this.getTimeInMillisecs()/$e.ONE_SECOND}getFrameCount(){return this.frameCount}getJsTime(){return this.averageJsTime}getGpuTime(){return this.averageGpuTime}}$e.ONE_SECOND=1e3;class Ke{constructor(){this.keysDown=new Map,document.onkeydown=e=>{this.keysDown.set(e.code,e)},document.onkeyup=e=>{this.keysDown.delete(e.code)}}isKeyDown(e){return!it.isDialogOpened()&&this.keysDown.has(e)}}class je{constructor(){this.movement=n()}update(){const e=Je.getDeltaTimeFactor();this.updateTranslation(e),this.updateRotation(e)}updateTranslation(e){const t=nt.isKeyDown("ShiftLeft")?10:1,i=je.MOVE_SPEED*e*t,s=rt.getForward(),n=rt.getRight();a(this.movement,0,0,0);let r=!1;nt.isKeyDown("KeyA")&&(c(this.movement,this.movement,n),r=!0),nt.isKeyDown("KeyD")&&(o(this.movement,this.movement,n),r=!0),nt.isKeyDown("KeyW")&&(o(this.movement,this.movement,s),r=!0),nt.isKeyDown("KeyS")&&(c(this.movement,this.movement,s),r=!0),r&&(function(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}(this.movement,l(this.movement,this.movement),i),rt.move(this.movement))}updateRotation(e){const t=je.ROTATION_SPEED*e;let i=0;nt.isKeyDown("KeyQ")&&(i+=t),nt.isKeyDown("KeyE")&&(i-=t),0!==i&&rt.rotate(i)}}let Je,Ze,et,tt,it,st,nt,rt,at,ot;async function ct(){try{console.log("This is a production build"),t=Array,Je=new $e,Ze=new B,et=new He,nt=new Ke,at=new je,ot=new Xe,await ot.initialize(lt),rt=new y,tt=new ke,st=new Ye,it=new Qe}catch(e){console.error(e),await ot.release()}await ht()}function lt(e,t){const i=[],s=Ze.getInstanceCount(),n=Ze.getCellSize();let r=w(Math.random(),Math.random(),Math.random());for(let a=0;a<s;a++){const s={position:w(e+Math.random()*n-n/2,.5,t+Math.random()*-n+n/2),rotation:w(0,0,0),scale:w(1,1,1),mesh:"cube",color:r};i.push(s)}return r=w(Math.random(),Math.random(),Math.random()),i.push({position:w(e,0,t),rotation:w(-90,0,0),scale:w(n/2,n/2,1),mesh:"quad",color:r}),i}async function ht(){Je.startFrame(),at.update(),await ot.render(),Je.endFrame(),requestAnimationFrame((async()=>{await ht()}))}je.MOVE_SPEED=.025,je.ROTATION_SPEED=.075,ct()})();